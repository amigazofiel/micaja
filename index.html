<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Caja - Control de Movimientos</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #007bff;
            --color-secondary: #6c757d;
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-warning: #ffc107;
            --color-bg-light: #f8f9fa;
            --color-bg-dark: #343a40;
            --color-text: #212529;
            --color-card-bg: #ffffff;
            --border-radius: 8px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--color-bg-light);
            color: var(--color-text);
            margin: 0;
            padding: 0;
            transition: background-color 0.3s;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
        }

        header {
            background-color: var(--color-primary);
            color: white;
            padding: 15px 20px;
            text-align: center;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        h1 {
            margin: 0;
            font-size: 1.8em;
        }

        .card {
            background-color: var(--color-card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        /* --- Formularios --- */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="number"], input[type="text"], select {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }
        
        button {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s, opacity 0.2s;
            margin-top: 10px;
        }

        button:hover:not(.disabled) {
            background-color: #0056b3;
        }
        
        button.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* --- Resumen y Estad√≠sticas --- */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            text-align: center;
        }

        .summary-box {
            padding: 15px;
            border-radius: var(--border-radius);
            font-size: 1.1em;
            font-weight: bold;
            color: white;
        }

        .summary-box.ventas { background-color: var(--color-success); }
        .summary-box.compras { background-color: #ff7e5f; } /* Naranja suave */
        .summary-box.gastos { background-color: var(--color-danger); }
        .summary-box.ganancia { 
            background-color: var(--color-bg-dark); 
            min-height: 50px; /* Asegura espacio */
        } 
        
        #ganancia-valor {
            font-size: 1.5em;
            margin-top: 5px;
            display: block;
            color: white !important; /* El color se define en JS */
        }
        
        .monto-venta { color: var(--color-success); font-weight: bold; }
        .monto-gasto { color: var(--color-danger); font-weight: bold; }


        /* --- Lista de Movimientos --- */
        #lista-movimientos {
            list-style: none;
            padding: 0;
        }

        #lista-movimientos li {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
            align-items: center;
        }
        
        #lista-movimientos li:last-child {
            border-bottom: none;
        }

        .delete-btn {
            background: none;
            color: var(--color-danger);
            border: none;
            padding: 5px;
            margin-top: 0;
            font-size: 1.2em;
            cursor: pointer;
        }
        
        /* --- Gesti√≥n de Suscripci√≥n (Footer) --- */
        footer {
            text-align: center;
            padding: 10px 0;
            margin-top: 20px;
            font-size: 0.9em;
            border-top: 1px solid #ccc;
        }
        
        footer button {
            margin: 5px;
            padding: 8px 15px;
            font-size: 0.9em;
        }
        
        #subscription-status {
            padding: 10px;
            border-radius: var(--border-radius);
            margin: 10px 0;
            font-weight: bold;
        }

        .alert-success { background-color: #d4edda; color: var(--color-success); }
        .alert-warning { background-color: #fff3cd; color: var(--color-warning); }
        .alert-danger { background-color: #f8d7da; color: var(--color-danger); }
        
        /* --- Bloqueo de la Aplicaci√≥n --- */
        .app-blocked #caja-form button:not(#pay-button),
        .app-blocked #admin-panel,
        .app-blocked #data-tools button:not(#export-btn) {
             pointer-events: none;
             opacity: 0.4;
        }
        
        .app-blocked .summary-grid {
             opacity: 0.7;
        }

        /* --- Admin Panel (Editor de Productos) --- */
        #admin-panel {
            display: none; /* INICIALMENTE OCULTO */
            border-left: 5px solid var(--color-secondary);
        }

        .admin-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .editor-section {
            padding: 15px;
            border: 1px dashed #ccc;
            border-radius: 4px;
        }

        #lista-categorias {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            margin-top: 10px;
        }

        .categoria-item, .producto-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #f1f1f1;
        }

        .categoria-item {
            background-color: #f0f0f0;
            font-weight: bold;
        }

        .btn-cat-del, .btn-producto-del {
            background-color: var(--color-danger);
            color: white;
            padding: 5px 10px;
            margin: 0;
            font-size: 0.8em;
        }
        
        .btn-producto-del {
            background-color: var(--color-secondary);
            width: 30px;
            height: 30px;
            font-size: 1em;
            text-align: center;
            padding: 0;
        }
        
        .two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Mi Caja üí∏</h1>
    </header>

    <div class="card">
        <h2>Estado de la Aplicaci√≥n</h2>
        <div id="subscription-status" class="alert-warning"></div>
        <div class="two-columns">
            <button id="pay-button" onclick="pedirCodigoActivacion()">Ingresar C√≥digo de Activaci√≥n</button>
            <button id="dev-license-btn" style="display:none;" onclick="activarLicenciaAdmin()">Activar DEV (Solo Admin)</button>
        </div>
        <p style="margin-top: 15px; font-size: 0.8em;">ID de Cliente: <span id="client-id-display" style="font-weight: bold;">Cargando...</span></p>
    </div>
    
    <div id="admin-panel" class="card">
        <h2>‚öôÔ∏è Panel de Administraci√≥n (DEV)</h2>
        <p>Herramientas de gesti√≥n de cat√°logo de productos.</p>
        
        <div class="admin-controls">
            <div class="editor-section">
                <h3>Agregar Elementos</h3>
                
                <div class="form-group">
                    <label for="nueva-categoria-input">Nueva Categor√≠a</label>
                    <input type="text" id="nueva-categoria-input" placeholder="Ej: Verduras">
                    <button onclick="agregarCategoria()">+ Categor√≠a</button>
                </div>
                
                <div class="form-group">
                    <label for="categoria-select-add">Categor√≠a del Producto</label>
                    <select id="categoria-select-add"></select>
                    
                    <label for="nuevo-producto-nombre" style="margin-top: 10px;">Nuevo Producto</label>
                    <input type="text" id="nuevo-producto-nombre" placeholder="Ej: Tomate perita">
                    <button onclick="agregarProducto()">+ Producto</button>
                </div>
            </div>
            
            <div class="editor-section">
                <h3>Categor√≠as y Productos Actuales</h3>
                <ul id="lista-categorias">
                    </ul>
            </div>
        </div>
        
    </div>
    
    <div class="card" id="caja-form">
        <h2>Registro R√°pido</h2>
        <div class="form-group two-columns">
            <div>
                <label for="tipo-movimiento">Tipo</label>
                <select id="tipo-movimiento">
                    <option value="venta">Venta (+) </option>
                    <option value="compra">Compra (-)</option>
                    <option value="gasto">Gasto (-)</option>
                </select>
            </div>
            <div>
                <label for="monto">Monto ($)</label>
                <input type="number" id="monto" placeholder="Ej: 1500.50">
            </div>
        </div>
        
        <div class="form-group">
            <label for="producto-select">Producto de Listado</label>
            <select id="producto-select">
                </select>
        </div>
        
        <div class="form-group">
            <label for="producto-manual">O Descripci√≥n Manual (Si no est√° en el listado)</label>
            <input type="text" id="producto-manual" placeholder="Ej: Servicio de Luz">
        </div>
        
        <button onclick="agregarMovimiento()">Registrar Movimiento</button>
    </div>

    <div class="card">
        <h2>Resumen del D√≠a</h2>
        <div class="summary-grid">
            <div class="summary-box ventas">
                Ventas
                <span id="total-ventas">$0.00</span>
            </div>
            <div class="summary-box compras">
                Compras
                <span id="total-compras">$0.00</span>
            </div>
            <div class="summary-box gastos">
                Gastos
                <span id="total-gastos">$0.00</span>
            </div>
            <div class="summary-box ganancia">
                Ganancia Neta
                <span id="ganancia-valor" style="color: var(--color-success);">$0.00</span>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="two-columns">
            <div>
                <h3>√öltimos Movimientos de Hoy</h3>
                <ul id="lista-movimientos">
                    </ul>
            </div>
            <div>
                <h3>Top 5 Productos (Ventas)</h3>
                <ul id="lista-top-productos">
                    </ul>
            </div>
        </div>
        
        <div id="data-tools" style="margin-top: 20px;">
            <button id="export-btn" onclick="exportarResumen()" style="background-color: var(--color-secondary);">Exportar Resumen CSV</button>
            <button onclick="borrarDatosDia()" style="background-color: var(--color-danger);">Borrar Movimientos del D√≠a</button>
        </div>
    </div>

</div> <script>
    // --- L√ìGICA DE LA APLICACI√ìN (JAVASCRIPT) ---
    
    // CLAVES IMPORTANTES
    const STORAGE_KEY = 'miCaja_movimientos';
    const SUBSCRIPTION_KEY = 'miCaja_subscripcion';
    const CLIENT_ID_KEY = 'miCaja_client_id'; 
    const PRODUCTOS_KEY = 'miCaja_productos_extensos'; // CLAVE para la lista editable
    const GRACE_PERIOD_MS = 24 * 60 * 60 * 1000;
    const SUB_DURATION_MS = 30 * 24 * 60 * 60 * 1000;
    const ADMIN_KEY = 'miCaja_admin_license';
    const ADMIN_UNLOCK_PHRASE = 'desarrollador-maestro'; // <<--- ESTA ES LA CLAVE SECRETA EXCLUSIVA
    
    // --- BASE DE DATOS EXTENSA INICIAL (USADA SOLO LA PRIMERA VEZ) ---
    const PRODUCTOS_INICIALES = {
        "Abarrotes y Despensa": [
            "Aceite Comestible", "Arroz Blanco", "At√∫n en Lata", "Az√∫car", "Caf√© Molido", 
            "Caldos y Sazonadores", "Fideos (Pasta Seca)", "Harina de Trigo", "Lentejas", 
            "Mermelada", "Pan Rallado", "Sal Com√∫n", "Sopa Instant√°nea", "Yerba Mate"
        ],
        "L√°cteos y Refrigerados": [
            "Crema de Leche", "Huevo (Docena)", "Leche Entera", "Mantequilla", "Margarina", 
            "Queso Cremoso", "Queso Rallado", "Yogur Bebible", "Yogur en Pote"
        ],
        "Bebidas y Jugos": [
            "Agua Mineral (Botella)", "Bebida Isot√≥nica", "Cerveza (Lata)", "Gaseosa (1.5L)", 
            "Gaseosa (2.25L)", "Jugo en Polvo", "Jugo Listo (Cart√≥n)", "Vino (Tinto/Blanco)"
        ],
        "Limpieza y Hogar": [
            "Detergente Lavaplatos", "Detergente Ropa", "Lavandina/Cloro", "Limpiador de Pisos", 
            "Papel Higi√©nico", "Servilletas", "Trapo de Piso", "Bolsa de Residuos"
        ],
        "Snacks y Golosinas": [
            "Almendras (Bolsa)", "Chicle", "Chocolate", "Galletas Dulces", "Man√≠ Tostado", 
            "Papas Fritas (Bolsa)", "Caramelos", "Barra de Cereal"
        ],
        "Panader√≠a y Reposter√≠a": [
            "Bizcochos", "Facturas (Unidad)", "Medialunas", "Pan de Molde", "Pan Franc√©s (Kilo)",
            "Tarta (Porci√≥n)"
        ]
    };
    
    // --- FUNCIONES DE ALMACENAMIENTO DE PRODUCTOS ---
    function obtenerProductos() {
        const productosGuardados = localStorage.getItem(PRODUCTOS_KEY);
        if (productosGuardados) {
            return JSON.parse(productosGuardados);
        }
        localStorage.setItem(PRODUCTOS_KEY, JSON.stringify(PRODUCTOS_INICIALES));
        return PRODUCTOS_INICIALES;
    }

    function guardarProductos(productos) {
        localStorage.setItem(PRODUCTOS_KEY, JSON.stringify(productos));
        cargarSelectProductos(); 
        cargarEditorProductos(); 
    }

    // --- FUNCIONES DEL EDITOR DE PRODUCTOS (GESTI√ìN) ---
    function agregarCategoria() {
        const input = document.getElementById('nueva-categoria-input');
        const nombre = input.value.trim();
        if (!nombre) {
            alert("El nombre de la categor√≠a no puede estar vac√≠o.");
            return;
        }
        
        const productos = obtenerProductos();
        const nombreNormalizado = nombre.charAt(0).toUpperCase() + nombre.slice(1).toLowerCase();

        if (productos.hasOwnProperty(nombreNormalizado)) {
            alert("Esa categor√≠a ya existe.");
            return;
        }
        
        productos[nombreNormalizado] = [];
        guardarProductos(productos);
        input.value = '';
    }
    
    function eliminarCategoria(nombre) {
        if (!confirm(`¬øEst√°s seguro de que quieres eliminar la categor√≠a "${nombre}"? ¬°Se borrar√°n todos sus productos!`)) return;
        const productos = obtenerProductos();
        delete productos[nombre];
        guardarProductos(productos);
    }

    function agregarProducto() {
        const nombreInput = document.getElementById('nuevo-producto-nombre');
        const categoriaSelect = document.getElementById('categoria-select-add');
        
        const nombre = nombreInput.value.trim();
        const categoria = categoriaSelect.value;
        
        if (!nombre) {
            alert("El nombre del producto no puede estar vac√≠o.");
            return;
        }
        if (!categoria) {
            alert("Debes seleccionar una categor√≠a.");
            return;
        }
        
        const productos = obtenerProductos();
        const nombreNormalizado = nombre.charAt(0).toUpperCase() + nombre.slice(1);
        
        if (productos[categoria].includes(nombreNormalizado)) {
            alert("Ese producto ya existe en esta categor√≠a.");
            return;
        }

        productos[categoria].push(nombreNormalizado);
        productos[categoria].sort();
        guardarProductos(productos);
        
        nombreInput.value = '';
    }
    
    function eliminarProducto(categoria, nombre) {
        if (!confirm(`¬øEst√°s seguro de que quieres eliminar "${nombre}"?`)) return;

        const productos = obtenerProductos();
        if (productos[categoria]) {
            productos[categoria] = productos[categoria].filter(p => p !== nombre); 
            guardarProductos(productos);
        }
    }

    function cargarEditorProductos() {
        const productos = obtenerProductos();
        const listaEditor = document.getElementById('lista-categorias');
        const selectAdd = document.getElementById('categoria-select-add');
        
        listaEditor.innerHTML = '';
        selectAdd.innerHTML = '<option value="" disabled selected>Selecciona una categor√≠a existente</option>';
        
        const categoriasOrdenadas = Object.keys(productos).sort();

        categoriasOrdenadas.forEach(categoria => {
            const option = document.createElement('option');
            option.value = categoria;
            option.textContent = categoria;
            selectAdd.appendChild(option);
            
            const catLi = document.createElement('li');
            catLi.className = 'categoria-item';
            catLi.innerHTML = `
                <span>${categoria}</span>
                <button class="btn-cat-del" onclick="eliminarCategoria('${categoria.replace(/'/g, "\\'")}')">Eliminar Cat.</button>
            `;
            listaEditor.appendChild(catLi);
            
            productos[categoria].forEach(producto => {
                const prodLi = document.createElement('li');
                prodLi.className = 'producto-item';
                prodLi.innerHTML = `
                    <span>${producto}</span>
                    <button class="btn-producto-del" onclick="eliminarProducto('${categoria.replace(/'/g, "\\'")}', '${producto.replace(/'/g, "\\'")}')">üóëÔ∏è</button>
                `;
                listaEditor.appendChild(prodLi);
            });
        });
        if (selectAdd.options.length > 1) {
             selectAdd.selectedIndex = 1;
        } 
    }
    

    // --- FUNCIONES DE CARGA Y NORMALIZACI√ìN ---

    function cargarSelectProductos() {
        const productos = obtenerProductos();
        const selectElement = document.getElementById('producto-select');
        
        selectElement.innerHTML = '<option value="" disabled selected>Selecciona un producto del listado...</option>'; 
        
        const categoriasOrdenadas = Object.keys(productos).sort();
        
        categoriasOrdenadas.forEach(categoria => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = categoria;
            
            productos[categoria].forEach(producto => {
                const option = document.createElement('option');
                option.value = producto;
                option.textContent = producto;
                optgroup.appendChild(option);
            });
            selectElement.appendChild(optgroup);
        });
    }
    
    const removerAcentos = (str) => {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    };

    function normalizarProducto(producto) {
        if (!producto) return '';
        
        let limpio = producto.toLowerCase().trim();
        limpio = removerAcentos(limpio).replace(/[^a-z0-9\s]/g, '');
        
        // --- MAPEO MANUAL REFORZADO (Asegura consistencia) ---
        
        if (limpio.includes('azucar') || limpio.includes('asucar')) return 'Az√∫car'; 
        if (limpio.includes('leche') || limpio.includes('lecche') || limpio.includes('lechhes')) return 'Leche Entera'; 
        if (limpio.includes('pan') || limpio.includes('panes')) return 'Pan Franc√©s (Kilo)'; 
        if (limpio.includes('gaseosa') || limpio.includes('coca') || limpio.includes('pepsi')) return 'Gaseosa (2.25L)'; 
        if (limpio.includes('fideo') || limpio.includes('tallarin') || limpio.includes('pastas')) return 'Fideos (Pasta Seca)'; 
        if (limpio.includes('arroz') || limpio.includes('arros')) return 'Arroz Blanco'; 
        if (limpio.includes('proveedor') || limpio.includes('probeor') || limpio.includes('probeor1') || limpio.includes('proveedor1')) return 'Proveedor'; 
        if (limpio.includes('tarte')) return 'Tarta (Porci√≥n)'; 

        let productoLimpio = producto.trim().toLowerCase();
        return productoLimpio.charAt(0).toUpperCase() + productoLimpio.slice(1);
    }

    // --- GESTI√ìN DE CAJA ---
    function obtenerMovimientos() { 
        const movimientos = localStorage.getItem(STORAGE_KEY);
        return movimientos ? JSON.parse(movimientos) : [];
    }

    function guardarMovimientos(movimientos) {
         localStorage.setItem(STORAGE_KEY, JSON.stringify(movimientos));
         renderizarResumen();
    }

    function agregarMovimiento() {
        if (document.body.classList.contains('app-blocked')) {
            alert("La aplicaci√≥n est√° suspendida. Por favor, renueva tu suscripci√≥n para continuar.");
            return;
        }
        
        const tipo = document.getElementById('tipo-movimiento').value;
        const monto = parseFloat(document.getElementById('monto').value);
        
        const productoSelect = document.getElementById('producto-select').value;
        const productoManual = document.getElementById('producto-manual').value;
        
        let productoBase = productoSelect || productoManual;

        if (isNaN(monto) || monto <= 0) {
             alert("Por favor, ingresa un monto v√°lido y mayor a cero.");
             return;
        }
        
        if (!productoBase) {
             alert("Por favor, selecciona un producto del listado o ingresa una descripci√≥n manual.");
             return;
        }
        
        const productoFinal = productoSelect ? productoBase : normalizarProducto(productoBase);


        const hoy = new Date().toLocaleDateString('es-AR', { timeZone: 'America/Argentina/Buenos_Aires' });
        const nuevoMovimiento = {
            id: Date.now(), 
            fecha: hoy,
            tipo: tipo,
            monto: monto,
            producto: productoFinal, 
            timestamp: Date.now()
        };

        const movimientos = obtenerMovimientos();
        movimientos.push(nuevoMovimiento);
        guardarMovimientos(movimientos);

        document.getElementById('monto').value = '';
        document.getElementById('producto-select').value = ''; 
        document.getElementById('producto-manual').value = ''; 
    }

    function eliminarMovimiento(id) {
        const movimientos = obtenerMovimientos();
        const movimientosFiltrados = movimientos.filter(mov => mov.id !== id);
        guardarMovimientos(movimientosFiltrados);
    }

    function renderizarResumen() { 
        const movimientos = obtenerMovimientos();
        const hoy = new Date().toLocaleDateString('es-AR', { timeZone: 'America/Argentina/Buenos_Aires' });
        const movimientosDia = movimientos.filter(mov => mov.fecha === hoy);

        let totalVentas = 0;
        let totalCompras = 0;
        let totalGastos = 0;
        const productosContador = {}; 

        movimientosDia.forEach(mov => {
            const productoConsistente = normalizarProducto(mov.producto); 

            if (mov.tipo === 'venta') {
                totalVentas += mov.monto;
                productosContador[productoConsistente] = (productosContador[productoConsistente] || 0) + 1; 
            } else if (mov.tipo === 'compra') {
                totalCompras += mov.monto;
            } else if (mov.tipo === 'gasto') {
                totalGastos += mov.monto;
            }
        });

        const totalEgresos = totalCompras + totalGastos;
        const gananciaDia = totalVentas - totalEgresos;

        document.getElementById('total-ventas').textContent = `$${totalVentas.toFixed(2)}`;
        document.getElementById('total-compras').textContent = `$${totalCompras.toFixed(2)}`;
        document.getElementById('total-gastos').textContent = `$${totalGastos.toFixed(2)}`;
        
        const gananciaElement = document.getElementById('ganancia-valor');
        gananciaElement.textContent = `$${gananciaDia.toFixed(2)}`;
        gananciaElement.style.color = gananciaDia >= 0 ? 'var(--color-success)' : 'var(--color-danger)';

        // --- DETALLE DE MOVIMIENTOS ---
        const listaMov = document.getElementById('lista-movimientos');
        listaMov.innerHTML = '';
        movimientosDia.sort((a, b) => b.timestamp - a.timestamp).forEach(mov => {
            const li = document.createElement('li');
            const signo = mov.tipo === 'venta' ? '+' : '-';
            const claseMonto = mov.tipo === 'venta' ? 'monto-venta' : 'monto-gasto';
            
            const productoParaMostrar = normalizarProducto(mov.producto); 
            const tipoEtiqueta = (mov.tipo === 'compra') ? 'compra' : (mov.tipo === 'gasto' ? 'gasto' : 'venta');


            li.innerHTML = `
                <span>${productoParaMostrar} (${tipoEtiqueta})</span>
                <span class="${claseMonto}">${signo} $${mov.monto.toFixed(2)}</span>
                <button class="delete-btn" onclick="eliminarMovimiento(${mov.id})">üóëÔ∏è</button>
            `;
            listaMov.appendChild(li);
        });
        
        // --- TOP PRODUCTOS ---
        const topProductosList = document.getElementById('lista-top-productos');
        topProductosList.innerHTML = '';
        
        const sortedProductos = Object.entries(productosContador)
            .sort(([, a], [, b]) => b - a) 
            .slice(0, 5);

        if (sortedProductos.length === 0) {
             topProductosList.innerHTML = '<li>A√∫n no hay ventas registradas hoy.</li>';
        } else {
            sortedProductos.forEach(([producto, cantidad]) => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${producto}</strong>: ${cantidad} ventas`;
                topProductosList.appendChild(li);
            });
        }
       }

    function borrarDatosDia() { 
        const hoy = new Date().toLocaleDateString('es-AR', { timeZone: 'America/Argentina/Buenos_Aires' });
        
        if (!confirm(`¬°ATENCI√ìN! ¬øEst√°s seguro de que quieres BORRAR TODOS los movimientos de HOY (${hoy})? Esta acci√≥n es irreversible. Recuerda exportar si quieres conservar el registro.`)) {
            return;
        }
        
        const movimientos = obtenerMovimientos();
        const movimientosRestantes = movimientos.filter(mov => mov.fecha !== hoy);
        
        guardarMovimientos(movimientosRestantes);
        alert("Los movimientos del d√≠a han sido borrados con √©xito. Se mantiene el hist√≥rico de otros d√≠as.");
       }

    function exportarResumen() { 
        const movimientos = obtenerMovimientos();
        const hoy = new Date().toLocaleDateString('es-AR', { timeZone: 'America/Argentina/Buenos_Aires' });
        const movimientosDia = movimientos.filter(mov => mov.fecha === hoy);
        
        if (movimientosDia.length === 0) {
            alert("No hay datos del d√≠a para exportar.");
            return;
        }

        let csvContent = "data:text/csv;charset=utf-8,Tipo;Monto;Producto;Fecha\n";

        movimientosDia.forEach(mov => {
            const cleanProduct = normalizarProducto(mov.producto).replace(/,/g, ' '); 
            const montoLocal = mov.monto.toFixed(2).replace('.', ','); 
            const row = [mov.tipo, montoLocal, cleanProduct, mov.fecha].join(';');
            csvContent += row + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `resumen_caja_${hoy.replace(/\//g, '-')}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        alert("Resumen del d√≠a exportado con √©xito.");
    }


    // --- GESTI√ìN DE LICENCIA (Suscripci√≥n y Admin) ---

    function generarClientID() {
        let id = localStorage.getItem(CLIENT_ID_KEY);
        if (!id) {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let newId = '';
            for (let i = 0; i < 4; i++) newId += chars.charAt(Math.floor(Math.random() * chars.length));
            newId += '-';
            for (let i = 0; i < 4; i++) newId += chars.charAt(Math.floor(Math.random() * chars.length));
            id = newId;
            localStorage.setItem(CLIENT_ID_KEY, id);
        }
        document.getElementById('client-id-display').textContent = id;
        return id;
    }

    function generarCodigoActivacionDesdeID(clienteIdInput) {
         const cleanId = clienteIdInput.replace(/-/g, '');
         let codigoGenerado = '';
         for (let i = 0; i < cleanId.length; i++) {
             const charCode = cleanId.charCodeAt(i);
             const newCharCode = charCode + (i % 3) + 1;
             codigoGenerado += String.fromCharCode(newCharCode);
         }
         return (codigoGenerado.slice(0, 4) + 'X' + codigoGenerado.slice(4)).toUpperCase();
    }

    function pedirCodigoActivacion() {
        const codigo = prompt("Ingresa el C√≥digo de Activaci√≥n (o la frase secreta DEV):");
        if (codigo) {
            const codigoLimpio = codigo.toUpperCase().trim();
            
            // 1. L√≥gica Exclusiva DEV: Comprueba la clave secreta
            if (codigoLimpio === ADMIN_UNLOCK_PHRASE.toUpperCase()) {
                 activarLicenciaAdmin();
                 return;
            }
            
            // 2. L√≥gica Normal de Cliente: Verifica c√≥digo de pago
            const expectedCode = generarCodigoActivacionDesdeID(generarClientID());
            
            if (codigoLimpio === expectedCode) {
                activarSuscripcion();
                alert("¬°Suscripci√≥n activada con √©xito! La aplicaci√≥n ya est√° lista para usar.");
            } else {
                alert("C√≥digo de activaci√≥n inv√°lido o incorrecto.");
            }
        }
    }
    
    function activarSuscripcion() {
        const expirationTime = Date.now() + SUB_DURATION_MS; // 30 d√≠as
        localStorage.setItem(SUBSCRIPTION_KEY, expirationTime);
        verificarSuscripcion();
    }

    function activarLicenciaAdmin() {
        localStorage.setItem(ADMIN_KEY, 'active');
        verificarSuscripcion();
        alert("üîë Licencia DEV activada. Ahora tienes acceso al Panel Admin.");
    }

    function verificarSuscripcion() {
        const statusElement = document.getElementById('subscription-status');
        const adminPanel = document.getElementById('admin-panel');
        const payButton = document.getElementById('pay-button');
        const now = Date.now();
        
        // --- Verificaci√≥n DEV (ADMIN) ---
        const isAdminActive = localStorage.getItem(ADMIN_KEY) === 'active';
        if (isAdminActive) {
            adminPanel.style.display = 'block'; // Muestra solo para el admin
            document.body.classList.remove('app-blocked');
            statusElement.className = 'alert-success';
            statusElement.textContent = "‚úÖ Licencia DEV Activa (ADMIN)";
            return;
        } else {
            adminPanel.style.display = 'none'; // Oculta para el resto
        }
        
        // --- Verificaci√≥n de Suscripci√≥n de Cliente Normal ---
        const expiryTimestamp = localStorage.getItem(SUBSCRIPTION_KEY);

        if (!expiryTimestamp) {
            // Primer uso / Per√≠odo de gracia.
            statusElement.className = 'alert-warning';
            statusElement.textContent = "‚ö†Ô∏è Per√≠odo de gracia. 3 d√≠as restantes.";
            document.body.classList.remove('app-blocked'); 
            payButton.classList.remove('disabled');
        } else if (now < parseInt(expiryTimestamp)) {
            // Suscripci√≥n Activa
            const daysLeft = Math.ceil((parseInt(expiryTimestamp) - now) / (24 * 60 * 60 * 1000));
            
            document.body.classList.remove('app-blocked');
            payButton.classList.remove('disabled');

            if (daysLeft <= 7) {
                statusElement.className = 'alert-warning';
                statusElement.textContent = `üü° Suscripci√≥n vence en ${daysLeft} d√≠as. ¬°Renueva!`;
            } else {
                statusElement.className = 'alert-success';
                statusElement.textContent = `üü¢ Suscripci√≥n Activa. Vence en ${daysLeft} d√≠as.`;
            }
        } else {
            // Suscripci√≥n Vencida (Bloqueo)
            document.body.classList.add('app-blocked');
            statusElement.className = 'alert-danger';
            statusElement.textContent = "üõë Aplicaci√≥n Bloqueada. Suscripci√≥n Vencida.";
            payButton.classList.remove('disabled');
        }
    }
    
    // --- INICIALIZACI√ìN ---
    function init() {
        generarClientID();
        verificarSuscripcion(); 
        obtenerProductos(); 
        cargarSelectProductos();
        cargarEditorProductos(); 
        renderizarResumen();
    }

    window.onload = init;
</script>

</body>
</html>
