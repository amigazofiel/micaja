<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Caja - Control de Movimientos</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #007bff;
            --color-secondary: #6c757d;
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-warning: #ffc107;
            --color-bg-light: #f8f9fa;
            --color-bg-dark: #343a40;
            --color-text: #212529;
            --color-card-bg: #ffffff;
            --border-radius: 8px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--color-bg-light);
            color: var(--color-text);
            margin: 0;
            padding: 0;
            transition: background-color 0.3s;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
        }

        header {
            background-color: var(--color-primary);
            color: white;
            padding: 15px 20px;
            text-align: center;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        h1 {
            margin: 0;
            font-size: 1.8em;
        }

        .card {
            background-color: var(--color-card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        /* --- Formularios --- */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="number"], input[type="text"], select {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }
        
        button {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s, opacity 0.2s;
            margin-top: 10px;
        }

        button:hover:not(.disabled) {
            background-color: #0056b3;
        }
        
        button.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* --- Resumen y Estad√≠sticas --- */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            text-align: center;
        }

        .summary-box {
            padding: 15px;
            border-radius: var(--border-radius);
            font-size: 1.1em;
            font-weight: bold;
            color: white;
        }

        .summary-box.ventas { background-color: var(--color-success); }
        .summary-box.compras { background-color: #ff7e5f; } /* Naranja suave */
        .summary-box.gastos { background-color: var(--color-danger); }
        .summary-box.ganancia { 
            background-color: var(--color-bg-dark); 
            min-height: 50px; /* Asegura espacio */
        } 
        
        #ganancia-valor {
            font-size: 1.5em;
            margin-top: 5px;
            display: block;
            color: white !important; /* El color se define en JS */
        }
        
        .monto-venta { color: var(--color-success); font-weight: bold; }
        .monto-gasto { color: var(--color-danger); font-weight: bold; }


        /* --- Lista de Movimientos --- */
        #lista-movimientos {
            list-style: none;
            padding: 0;
        }

        #lista-movimientos li {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
            align-items: center;
        }
        
        #lista-movimientos li:last-child {
            border-bottom: none;
        }

        .delete-btn {
            background: none;
            color: var(--color-danger);
            border: none;
            padding: 5px;
            margin-top: 0;
            font-size: 1.2em;
            cursor: pointer;
        }
        
        /* --- Gesti√≥n de Suscripci√≥n (Footer) --- */
        #subscription-status {
            padding: 10px;
            border-radius: var(--border-radius);
            margin: 10px 0;
            font-weight: bold;
        }

        .alert-success { background-color: #d4edda; color: var(--color-success); }
        .alert-warning { background-color: #fff3cd; color: var(--color-warning); }
        .alert-danger { background-color: #f8d7da; color: var(--color-danger); }
        
        /* --- Bloqueo de la Aplicaci√≥n --- */
        .app-blocked #caja-form button:not(#pay-button),
        .app-blocked #catalogo-panel, /* <-- ¬°BLOQUEO DE CAT√ÅLOGO REFORZADO! */
        .app-blocked #data-tools button:not(#export-btn),
        .app-blocked #caja-form select,
        .app-blocked #caja-form input {
             pointer-events: none;
             opacity: 0.4;
        }
        
        .app-blocked .summary-grid {
             opacity: 0.7;
        }

        /* --- Catalogo/Admin Panel --- */
        #admin-dev-panel {
            display: none; /* EXCLUSIVO DEV - OCULTO */
            border-left: 5px solid var(--color-danger);
        }
        
        #catalogo-panel {
            border-left: 5px solid var(--color-success); /* Visible para el comerciante */
        }

        .admin-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .editor-section {
            padding: 15px;
            border: 1px dashed #ccc;
            border-radius: 4px;
        }

        #lista-categorias {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            margin-top: 10px;
        }

        .categoria-item, .producto-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #f1f1f1;
        }

        .categoria-item {
            background-color: #f0f0f0;
            font-weight: bold;
        }

        .btn-cat-del, .btn-producto-del {
            background-color: var(--color-danger);
            color: white;
            padding: 5px 10px;
            margin: 0;
            font-size: 0.8em;
        }
        
        .btn-producto-del {
            background-color: var(--color-secondary);
            width: 30px;
            height: 30px;
            font-size: 1em;
            text-align: center;
            padding: 0;
        }
        
        .two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Mi Caja üí∏</h1>
    </header>

    <div class="card">
        <h2>Estado de la Aplicaci√≥n</h2>
        <div id="subscription-status" class="alert-warning"></div>
        <div class="two-columns">
            <button id="pay-button" onclick="pedirCodigoActivacion()">Ingresar C√≥digo de Activaci√≥n</button>
        </div>
        <p style="margin-top: 15px; font-size: 0.8em;">ID de Cliente: <span id="client-id-display" style="font-weight: bold;">Cargando...</span></p>
    </div>
    
    <div id="catalogo-panel" class="card">
        <h2>üõçÔ∏è Cat√°logo de Productos</h2>
        <p>Edita tus categor√≠as y productos para facilitar el registro de ventas. Los cambios se guardan autom√°ticamente.</p>
        
        <div class="admin-controls">
            <div class="editor-section">
                <h3>Agregar Elementos</h3>
                
                <div class="form-group">
                    <label for="nueva-categoria-input">Nueva Categor√≠a</label>
                    <input type="text" id="nueva-categoria-input" placeholder="Ej: Verduras">
                    <button onclick="agregarCategoria()">+ Categor√≠a</button>
                </div>
                
                <div class="form-group">
                    <label for="categoria-select-add">Categor√≠a del Producto</label>
                    <select id="categoria-select-add"></select>
                    
                    <label for="nuevo-producto-nombre" style="margin-top: 10px;">Nuevo Producto</label>
                    <input type="text" id="nuevo-producto-nombre" placeholder="Ej: Tomate perita">
                    <button onclick="agregarProducto()">+ Producto</button>
                </div>
            </div>
            
            <div class="editor-section">
                <h3>Categor√≠as y Productos Actuales</h3>
                <ul id="lista-categorias">
                    </ul>
            </div>
        </div>
        
    </div>

    <div id="admin-dev-panel" class="card">
        <h2>‚öôÔ∏è Panel de Desarrollo (ADMIN)</h2>
        <p>Herramientas de configuraci√≥n y mantenimiento EXCLUSIVAS del desarrollador.</p>
    </div>
    
    <div class="card" id="caja-form">
        <h2>Registro R√°pido</h2>
        <div class="form-group two-columns">
            <div>
                <label for="tipo-movimiento">Tipo</label>
                <select id="tipo-movimiento">
                    <option value="venta">Venta (+) </option>
                    <option value="compra">Compra (-)</option>
                    <option value="gasto">Gasto (-)</option>
                </select>
            </div>
            <div>
                <label for="monto">Monto ($)</label>
                <input type="number" id="monto" placeholder="Ej: 1500.50">
            </div>
        </div>
        
        <div class="form-group">
            <label for="producto-select">Producto de Listado (Desplegable por Categor√≠a)</label>
            <select id="producto-select">
                </select>
        </div>
        
        <div class="form-group">
            <label for="producto-manual">O Descripci√≥n Manual (Si no est√° en el listado)</label>
            <input type="text" id="producto-manual" placeholder="Ej: Servicio de Luz">
        </div>
        
        <button onclick="agregarMovimiento()">Registrar Movimiento</button>
    </div>

    <div class="card">
        <h2>Resumen del D√≠a</h2>
        <div class="summary-grid">
            <div class="summary-box ventas">
                Ventas
                <span id="total-ventas">$0.00</span>
            </div>
            <div class="summary-box compras">
                Compras
                <span id="total-compras">$0.00</span>
            </div>
            <div class="summary-box gastos">
                Gastos
                <span id="total-gastos">$0.00</span>
            </div>
            <div class="summary-box ganancia">
                Ganancia Neta
                <span id="ganancia-valor" style="color: var(--color-success);">$0.00</span>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="two-columns">
            <div>
                <h3>√öltimos Movimientos de Hoy</h3>
                <ul id="lista-movimientos">
                    </ul>
            </div>
            <div>
                <h3>Top 5 Productos (Ventas)</h3>
                <ul id="lista-top-productos">
                    </ul>
            </div>
        </div>
        
        <div id="data-tools" style="margin-top: 20px;">
            <button id="export-btn" onclick="exportarResumen()" style="background-color: var(--color-secondary);">Exportar Resumen CSV</button>
            <button onclick="borrarDatosDia()" style="background-color: var(--color-danger);">Borrar Movimientos del D√≠a</button>
        </div>
    </div>

</div> <script>
    // --- L√ìGICA DE LA APLICACI√ìN (JAVASCRIPT) ---
    
    // CLAVES IMPORTANTES
    const STORAGE_KEY = 'miCaja_movimientos';
    const SUBSCRIPTION_KEY = 'miCaja_subscripcion';
    const CLIENT_ID_KEY = 'miCaja_client_id'; 
    const PRODUCTOS_KEY = 'miCaja_productos_extensos'; 
    const GRACE_PERIOD_MS = 24 * 60 * 60 * 1000;
    const SUB_DURATION_MS = 30 * 24 * 60 * 60 * 1000;
    const ADMIN_KEY = 'miCaja_admin_license';
    const ADMIN_UNLOCK_PHRASE = 'desarrollador-maestro'; // <<--- CLAVE SECRETA EXCLUSIVA DEV
    
    // --- BASE DE DATOS EXTENSA INICIAL (USADA SOLO LA PRIMERA VEZ) ---
    const PRODUCTOS_INICIALES = {
        "Alimentos congelados": [
            "Arvejas congeladas", "Bastones de merluza", "Croquetas de papa", "Empanadas congeladas", 
            "Espinaca congelada", "Filet de merluza", "Hamburguesas de carne", "Hamburguesas de pollo", 
            "Helado chocolate", "Helado crema americana", "Helado frutilla", "Helado vainilla", 
            "Medallones de merluza", "Medallones de verdura", "Milanesas de soja", "Mix de frutas congeladas",
            "Nuggets de pollo", "√ëoquis congelados", "Pan de ajo congelado", "Papas fritas congeladas", 
            "Pizzetas congeladas", "Postre helado", "Ravioles congelados", "Rebozados de pescado", 
            "Supremas de pollo", "Tapas para empanadas congeladas", "Tapas para tartas congeladas", 
            "Tortillas de papa", "Verduras para wok"
        ],
        "Almacen / Despensa": [
            "Aceite de girasol", "Aceite de oliva", "Avena", "Arroz largo fino", "Arroz parboil", 
            "Az√∫car com√∫n", "Az√∫car mascabo", "Cacao en polvo", "Caf√© instant√°neo", "Caf√© molido", 
            "Caldo de gallina", "Caldo de verduras", "Fideos guiseros", "Fideos mo√±ito", "Fideos spaghetti", 
            "Harina com√∫n 000", "Harina integral", "Harina leudante", "Lentejas secas", "Mate cocido", 
            "Polenta", "Porotos", "Pur√© de tomate", "Salsa de tomate", "T√© en saquitos", "Vinagre de alcohol", 
            "Vinagre de vino", "Yerba mate"
        ],
        "Bebidas alcoh√≥licas": [
            "An√≠s", "Aperitivo tipo vermut", "Ca√±a", "Cerveza artesanal", "Cerveza en botella", "Cerveza en lata", 
            "Cerveza negra", "Cerveza rubia", "Cerveza sin alcohol", "Cerveza sin gluten", "Champagne", 
            "Coctel preparado", "Espumante", "Fernet", "Gancia", "Gin", "Licor de caf√©", "Licor de dulce de leche", 
            "Licor de hierbas", "Mini botellas (shots)", "Ron", "Sidra", "Vino blanco", "Vino fino", "Vino reserva", 
            "Vino rosado", "Vino tetrabrik", "Vino tinto", "Vodka", "Whisky"
        ],
        "Bebidas sin alcohol": [
            "Agua con gas", "Agua con sabor", "Agua con vitaminas", "Agua mineral", "Agua mineral sin sodio", 
            "Agua saborizada", "Agua sin gas", "Agua para beb√©s", "Bebida a base de t√© verde", 
            "Bebida vegetal de almendras", "Bebida vegetal de avena", "Caf√© fr√≠o embotellado", "Energizante", 
            "Gaseosa cola", "Gaseosa lima lim√≥n", "Gaseosa naranja", "Isot√≥nica", "Jugo en botella", 
            "Jugo en polvo", "Jugo multifruta", "Jugo natural exprimido", "Kombucha", "Leche chocolatada", 
            "Limonada", "Naranjada", "N√©ctar de durazno", "N√©ctar de manzana", "N√©ctar de pera", "Smoothie", 
            "Soda", "T√© fr√≠o"
        ],
        "Cereales y galletitas": [
            "Alfajor de maicena", "Alfajor simple", "Alfajor triple", "Arroz inflado", "Barritas de cereal", 
            "Bizcochitos", "Bud√≠n", "Cereal con chocolate", "Cereal con frutas", "Cereal crocante", "Cereal de avena", 
            "Cereal de ma√≠z", "Cereal infantil", "Copos de ma√≠z", "Galletas de arroz", "Galletitas de agua", 
            "Galletitas dulces", "Galletitas integrales", "Galletitas rellenas", "Galletitas saladas", 
            "Galletitas sin az√∫car", "Galletitas sin TACC", "Granola", "Grisines", "Magdalenas", "Obleas", 
            "Pan dulce", "Salvado de trigo", "Snack de avena", "Turrones"
        ],
        "Condimentos y aderezos": [
            "Aceite de girasol", "Aceite de ma√≠z", "Aceite de oliva", "Aderezo para ensaladas", "Aderezo tipo caesar", 
            "Aderezo tipo ranch", "Aj√≠ molido", "C√∫rcuma", "Curry", "Comino", "Ketchup", "Laurel", "Mayonesa", 
            "Mostaza", "Or√©gano", "Perejil seco", "Pimienta blanca molida", "Pimienta negra molida", "Piment√≥n dulce", 
            "Piment√≥n picante", "Provenzal", "Sal fina", "Sal gruesa", "Salsa barbacoa", "Salsa de soja", "Salsa golf", 
            "Salsa inglesa", "Salsa tabasco", "Vinagre de manzana", "Vinagre de vino"
        ],
        "Cuidado del beb√©": [
            "Aceite para beb√©", "Agua para beb√©s", "Algod√≥n", "Arn√©s", "Babero", "Biber√≥n", "Cereal infantil", 
            "Cepillo de cerdas suaves", "Chupete", "Cintur√≥n de auto para perro", "Colonia beb√©", "Cotonetes", 
            "Crema para paspaduras", "Esponja suave", "Gasas est√©riles", "Jab√≥n l√≠quido beb√©", "Juguete de ba√±o", 
            "Leche maternizada", "Loci√≥n hidratante beb√©", "Mamadera", "Manta beb√©", "Pa√±ales descartables", 
            "Peine beb√©", "Plato y cuchara infantil", "Protector de cuna", "Set de u√±as beb√©", "Shampoo beb√©", 
            "Talco", "Toalla beb√©", "Toallitas desinfectantes", "Toallitas h√∫medas", "Toall√≥n beb√©"
        ],
        "Cuidado del cabello": [
            "Aceite para el cabello", "Acondicionador", "Acondicionador sin enjuague", "B√°lsamo capilar", 
            "Cepillo de pelo", "Cera capilar", "Crema de enjuague", "Crema para peinar", "Decolorante", 
            "Espuma moldeadora", "Gel capilar", "Gomitas para el cabello", "Hebillas", "Laca", "M√°scara capilar", 
            "Peine", "Protector t√©rmico", "Serum capilar", "Shampoo", "Shampoo anticaspa", "Shampoo hidratante", 
            "Shampoo neutro", "Shampoo normal", "Shampoo para beb√©", "Shampoo para cabello te√±ido", "Shampoo sin sal", 
            "Shampoo s√≥lido", "Spray fijador", "Tintura para el cabello", "T√≥nico capilar", "Tratamiento anti-frizz"
        ],
        "Cuidado facial y corporal": [
            "Aceite corporal", "After sun", "Agua micelar", "B√°lsamo labial", "Colonia corporal", "Crema antiarrugas", 
            "Crema contorno de ojos", "Crema facial hidratante", "Crema humectante corporal", "Crema para manos", 
            "Crema para pies", "Desodorante en aerosol", "Desodorante en barra", "Desodorante √≠ntimo", 
            "Desodorante roll-on", "Exfoliante corporal", "Gel de ba√±o", "Jab√≥n de tocador", "Jab√≥n √≠ntimo", 
            "Jab√≥n l√≠quido corporal", "Limpiador facial", "Loci√≥n corporal", "Mascarilla facial", "Perfume", 
            "Protector solar corporal", "Protector solar facial", "Talco corporal", "Toallas desmaquillantes", 
            "Toallas h√∫medas corporales", "T√≥nico facial"
        ],
        "Dulces, golosinas y chocolates": [
            "Alfajor simple", "Alfajor triple", "Alfajor de maicena", "Barra de cereal con chocolate", "Bocadito dulce de leche", 
            "Bomb√≥n relleno", "Bombones", "Bon o bon", "Cacao para reposter√≠a", "Caramelos duros", "Caramelos masticables", 
            "Chicle", "Chocolate amargo", "Chocolate blanco", "Chocolate con leche", "Chocolate en barra", 
            "Chocolate para taza", "Confites", "Dulce de batata", "Dulce de leche", "Dulce de membrillo", 
            "Galletitas ba√±adas", "Golosina sin az√∫car", "Gomitas", "Malvaviscos", "Miel", "Pasta de man√≠", 
            "Pastillas", "Praline de man√≠", "Tableta de chocolate", "Turr√≥n de man√≠"
        ],
        "Fiambres y embutidos": [
            "Bondiola", "Bondiola ahumada", "Chorizo parrillero", "Chorizo seco", "Copet√≠n de salame", "Fiambre de pavo", 
            "Fiambre de pollo", "Fiambre light", "Fiambre picado fino", "Fiambre picado grueso", "Jam√≥n ahumado", 
            "Jam√≥n cocido", "Jam√≥n crudo", "Jam√≥n natural", "Leberwurst", "Lomito cocido", "Longaniza", "Morcilla", 
            "Mortadela", "Mortadela con pistacho", "Paleta cocida", "Panceta", "Pat√©", "Queso de cerdo", 
            "Queso untable con jam√≥n", "Salame", "Salam√≠n", "Salchicha parrillera", "Salchicha tipo viena", 
            "Salchich√≥n"
        ],
        "Hogar y limpieza": [
            "Ambientador el√©ctrico", "Balde", "Bolsas de residuos", "Cepillo de ba√±o", "Detergente lavavajillas", 
            "Detergente lavavajillas m√°quina", "Desinfectante", "Desodorante de ambientes", "Escoba", 
            "Esponja de cocina", "Esponja met√°lica", "Guantes de limpieza", "Insecticida", "Lavandina", 
            "Limpiador ba√±o", "Limpiador cremoso", "Limpiador multiuso", "Limpiador perfumado", "Limpiador pisos", 
            "Limpia hornos", "Limpiavidrios", "Pa√±o microfibra", "Pastilla para inodoro", "Recogedor", 
            "Repelente de insectos", "Rollo de cocina", "Secador de piso", "Suavizante para ropa", "Trapo de piso", 
            "Trapo rejilla"
        ],
        "L√°cteos": [
            "Crema de leche", "Flan", "Leche chocolatada", "Leche descremada", "Leche en polvo", "Leche entera", 
            "Leche parcialmente descremada", "Leche saborizada", "Manteca", "Margarina", "Postre de chocolate", 
            "Postre de vainilla", "Queso azul", "Queso barra", "Queso blanco", "Queso cabra", "Queso cremoso", 
            "Queso de m√°quina", "Queso mozzarella", "Queso pategr√°s", "Queso por salut", "Queso rallado", 
            "Queso rallado fino", "Queso untable", "Ricota", "Yogur bebible", "Yogur con cereales", "Yogur con frutas", 
            "Yogur descremado", "Yogur firme"
        ],
        "Mascotas": [
            "Alimento para cachorros", "Alimento para gatos senior", "Alimento seco para gato", "Alimento seco para perro", 
            "Alimento h√∫medo para gato", "Alimento h√∫medo para perro", "Arena absorbente", "Arena sanitaria para gato", 
            "Arn√©s", "Bebedero", "Bolsas sanitarias", "Camita", "Casa pl√°stica", "Cepillo para perro", 
            "Cintur√≥n de auto para perro", "Collar", "Comedero", "Correa", "Corta u√±as para mascota", 
            "Galletitas para perro", "Golosina dental para perro", "Hueso masticable", "Juguete de goma", 
            "Juguete para gato", "Juguete para perro", "Peine antipulgas", "Pelota de tenis", "Pipeta antipulgas", 
            "Shampoo para perro", "Talco antipulgas"
        ],
        "Panader√≠a y pasteler√≠a": [
            "Bizcochos", "Bizcochuelo", "Donas", "Facturas", "Galletas dulces", "Masa hojaldre", "Masa de pizza", 
            "Masa para tartas", "Medialunas", "Pan √°rabe", "Pan casero", "Pan de ajo congelado", "Pan de campo", 
            "Pan de campo integral", "Pan de hamburguesa", "Pan de manteca", "Pan de molde", "Pan de pancho", 
            "Pan franc√©s", "Pan integral", "Pan lactal", "Pan pita", "Pan rallado", "Pan de salvado", 
            "Pan saborizado", "Pan sin gluten", "Pizza", "Tarta dulce", "Tarta salada", "Tortas", "Bud√≠n"
        ],
        "Papel y descartables": [
            "Bandejas descartables", "Bolsas de consorcio", "Bolsas de residuos", "Bolsitas para freezer", 
            "Cajas de cart√≥n", "Cajas para tortas", "Cucharitas de pl√°stico", "Cubiertos biodegradables", 
            "Cubiertos descartables", "Envoltorio autoadhesivo", "Envoltorios pl√°sticos", "Film pl√°stico", 
            "Guantes descartables", "Manteles descartables", "Moldes de aluminio", "Pajitas de papel", 
            "Pa√±uelos descartables", "Papel aluminio", "Papel higi√©nico", "Papel manteca", "Platos descartables", 
            "Rollos de cocina", "Servilletas", "Sorbetes", "Tapas para vasos", "Tenedores de madera", 
            "Toallas de papel", "Toallitas h√∫medas", "Vasos descartables"
        ],
        "Pastas y arroces": [
            "Arroz doble carolina", "Arroz integral", "Arroz largo fino", "Arroz parboil", "Arroz para risotto", 
            "Arroz para sushi", "Canelones", "Capelettis", "Cous cous", "Fideos de arroz", "Fideos guiseros", 
            "Fideos integrales", "Fideos mostachol", "Fideos sin gluten", "Fideos spaghetti", "Fideos tirabuz√≥n", 
            "Harina de ma√≠z", "Lasagna seca", "√ëoquis", "Polenta", "Ravioles", "Salsa blanca lista", 
            "Salsa bolo√±esa lista", "Salsa carbonara", "Salsa cuatro quesos", "Salsa fileto", "Salsa pesto", 
            "S√©mola", "Sorrentinos", "Tallarines"
        ],
        "Productos de limpieza y perfumer√≠a": [
            "Acondicionador", "Algod√≥n", "Aromatizador autom√°tico", "Cepillo de dientes", "Crema corporal", 
            "Crema de manos", "Desinfectante", "Desodorante ambiental", "Desodorante corporal", "Detergente para ropa", 
            "Enjuague bucal", "Hisopos", "Jab√≥n corporal", "Jab√≥n en polvo", "Jab√≥n l√≠quido", "Lavandina", 
            "Limpiador de pisos", "Pa√±ales adultos", "Papel higi√©nico", "Pasta dental", "Perfume", 
            "Protectores diarios", "Quitamanchas", "Repelente corporal", "Servilletas", "Shampoo", 
            "Suavizante para ropa", "Toallas femeninas", "Toallas h√∫medas"
        ],
        "Verduler√≠a y fruter√≠a": [
            "Acelga", "Ajo", "Banana", "Batata", "Berenjena", "Br√≥coli", "Calabaza", "Cebolla", "Choclo", "Ciruela", 
            "Durazno", "Espinaca", "Frutilla", "Kiwi", "Lechuga", "Lim√≥n", "Mandarina", "Manzana", "Mel√≥n", "Naranja", 
            "Palta", "Papa", "Pepino", "Pera", "Pimiento", "Pomelo", "Repollo", "Sand√≠a", "Tomate", "Uva", 
            "Zanahoria", "Zapallo", "Zapallito", "Zucchini"
        ]
    };
    

    // --- FUNCIONES DE ALMACENAMIENTO DE PRODUCTOS ---
    function obtenerProductos() {
        const productosGuardados = localStorage.getItem(PRODUCTOS_KEY);
        if (productosGuardados) {
            return JSON.parse(productosGuardados);
        }
        
        // 1. Clonar y ordenar la base de datos inicial
        const productosOrdenados = {};
        const categoriasOrdenadas = Object.keys(PRODUCTOS_INICIALES).sort();

        categoriasOrdenadas.forEach(cat => {
            productosOrdenados[cat] = PRODUCTOS_INICIALES[cat].slice().sort(); // Ordena los productos
        });
        
        // 2. Guardar la versi√≥n inicial ordenada
        localStorage.setItem(PRODUCTOS_KEY, JSON.stringify(productosOrdenados));
        return productosOrdenados;
    }

    function guardarProductos(productos) {
        // Asegura que al guardar, las categor√≠as y productos est√©n ordenados
        const productosOrdenados = {};
        const categorias = Object.keys(productos).sort();
        
        categorias.forEach(cat => {
            productosOrdenados[cat] = productos[cat].slice().sort();
        });

        localStorage.setItem(PRODUCTOS_KEY, JSON.stringify(productosOrdenados));
        cargarSelectProductos(); 
        cargarEditorProductos(); 
    }

    // --- FUNCIONES DEL EDITOR DE PRODUCTOS (GESTI√ìN) ---
    function agregarCategoria() {
        const input = document.getElementById('nueva-categoria-input');
        const nombre = input.value.trim();
        if (!nombre) {
            alert("El nombre de la categor√≠a no puede estar vac√≠o.");
            return;
        }
        
        const productos = obtenerProductos();
        // Capitalizaci√≥n simple para consistencia, manteniendo el nombre original
        const nombreNormalizado = nombre.charAt(0).toUpperCase() + nombre.slice(1); 

        if (productos.hasOwnProperty(nombreNormalizado)) {
            alert("Esa categor√≠a ya existe.");
            return;
        }
        
        productos[nombreNormalizado] = [];
        guardarProductos(productos);
        input.value = '';
    }
    
    function eliminarCategoria(nombre) {
        if (!confirm(`¬øEst√°s seguro de que quieres eliminar la categor√≠a "${nombre}"? ¬°Se borrar√°n todos sus productos!`)) return;
        const productos = obtenerProductos();
        delete productos[nombre];
        guardarProductos(productos);
    }

    function agregarProducto() {
        const nombreInput = document.getElementById('nuevo-producto-nombre');
        const categoriaSelect = document.getElementById('categoria-select-add');
        
        const nombre = nombreInput.value.trim();
        const categoria = categoriaSelect.value;
        
        if (!nombre) {
            alert("El nombre del producto no puede estar vac√≠o.");
            return;
        }
        if (!categoria) {
            alert("Debes seleccionar una categor√≠a.");
            return;
        }
        
        const productos = obtenerProductos();
        const nombreNormalizado = nombre.charAt(0).toUpperCase() + nombre.slice(1);
        
        if (productos[categoria].includes(nombreNormalizado)) {
            alert("Ese producto ya existe en esta categor√≠a.");
            return;
        }

        productos[categoria].push(nombreNormalizado);
        // El orden se asegura en guardarProductos()
        guardarProductos(productos);
        
        nombreInput.value = '';
    }
    
    function eliminarProducto(categoria, nombre) {
        if (!confirm(`¬øEst√°s seguro de que quieres eliminar "${nombre}" de la categor√≠a ${categoria}?`)) return;

        const productos = obtenerProductos();
        if (productos[categoria]) {
            productos[categoria] = productos[categoria].filter(p => p !== nombre); 
            guardarProductos(productos);
        }
    }

    function cargarEditorProductos() {
        const productos = obtenerProductos();
        const listaEditor = document.getElementById('lista-categorias');
        const selectAdd = document.getElementById('categoria-select-add');
        
        listaEditor.innerHTML = '';
        selectAdd.innerHTML = '<option value="" disabled selected>Selecciona una categor√≠a existente</option>';
        
        // Las categor√≠as ya vienen ordenadas alfab√©ticamente desde obtenerProductos/guardarProductos
        const categoriasOrdenadas = Object.keys(productos);

        categoriasOrdenadas.forEach(categoria => {
            const option = document.createElement('option');
            option.value = categoria;
            option.textContent = categoria;
            selectAdd.appendChild(option);
            
            const catLi = document.createElement('li');
            catLi.className = 'categoria-item';
            catLi.innerHTML = `
                <span>${categoria} (${productos[categoria].length} productos)</span>
                <button class="btn-cat-del" onclick="eliminarCategoria('${categoria.replace(/'/g, "\\'")}')">Eliminar Cat.</button>
            `;
            listaEditor.appendChild(catLi);
            
            // Los productos ya vienen ordenados alfab√©ticamente
            productos[categoria].forEach(producto => {
                const prodLi = document.createElement('li');
                prodLi.className = 'producto-item';
                prodLi.innerHTML = `
                    <span>- ${producto}</span>
                    <button class="btn-producto-del" onclick="eliminarProducto('${categoria.replace(/'/g, "\\'")}', '${producto.replace(/'/g, "\\'")}')">üóëÔ∏è</button>
                `;
                listaEditor.appendChild(prodLi);
            });
        });
        if (selectAdd.options.length > 1) {
             selectAdd.selectedIndex = 0; // Deja la opci√≥n por defecto visible
        } 
    }
    

    // --- FUNCIONES DE CARGA Y NORMALIZACI√ìN ---

    function cargarSelectProductos() {
        const productos = obtenerProductos();
        const selectElement = document.getElementById('producto-select');
        
        selectElement.innerHTML = '<option value="" disabled selected>Selecciona un producto del listado...</option>'; 
        
        // Las categor√≠as ya vienen ordenadas
        const categoriasOrdenadas = Object.keys(productos);
        
        categoriasOrdenadas.forEach(categoria => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = categoria;
            
            // Los productos ya vienen ordenados
            productos[categoria].forEach(producto => {
                const option = document.createElement('option');
                option.value = producto;
                option.textContent = producto;
                optgroup.appendChild(option);
            });
            selectElement.appendChild(optgroup);
        });
    }
    
    const removerAcentos = (str) => {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    };

    function normalizarProducto(producto) {
        if (!producto) return '';
        
        // 1. Normalizaci√≥n simple (capitalizaci√≥n y limpieza b√°sica)
        let productoLimpio = producto.trim().toLowerCase();
        let normalizado = productoLimpio.charAt(0).toUpperCase() + productoLimpio.slice(1);
        
        // 2. Mapeo espec√≠fico de la lista inicial (para evitar inconsistencias en el resumen)
        const productosActuales = obtenerProductos();
        const productoSinAcentos = removerAcentos(productoLimpio);

        for (const categoria in productosActuales) {
            for (const item of productosActuales[categoria]) {
                if (removerAcentos(item.toLowerCase()) === productoSinAcentos) {
                    return item; // Devuelve el nombre exacto del listado
                }
            }
        }
        
        // Si no se encuentra en el listado, se devuelve la versi√≥n capitalizada
        return normalizado; 
    }

    // --- GESTI√ìN DE CAJA (Movimientos y Resumen) ---
    function obtenerMovimientos() { 
        const movimientos = localStorage.getItem(STORAGE_KEY);
        return movimientos ? JSON.parse(movimientos) : [];
    }

    function guardarMovimientos(movimientos) {
         localStorage.setItem(STORAGE_KEY, JSON.stringify(movimientos));
         renderizarResumen();
    }

    function agregarMovimiento() {
        if (document.body.classList.contains('app-blocked')) {
            alert("üõë La aplicaci√≥n est√° Bloqueada. Suscripci√≥n Vencida. Por favor, ingresa el C√≥digo de Activaci√≥n para registrar movimientos.");
            return;
        }
        
        const tipo = document.getElementById('tipo-movimiento').value;
        const monto = parseFloat(document.getElementById('monto').value);
        
        const productoSelect = document.getElementById('producto-select').value;
        const productoManual = document.getElementById('producto-manual').value;
        
        let productoBase = productoSelect || productoManual;

        if (isNaN(monto) || monto <= 0) {
             alert("Por favor, ingresa un monto v√°lido y mayor a cero.");
             return;
        }
        
        if (!productoBase) {
             alert("Por favor, selecciona un producto del listado o ingresa una descripci√≥n manual.");
             return;
        }
        
        const productoFinal = normalizarProducto(productoBase); // Usa la normalizaci√≥n para consistencia


        const hoy = new Date().toLocaleDateString('es-AR', { timeZone: 'America/Argentina/Buenos_Aires' });
        const nuevoMovimiento = {
            id: Date.now(), 
            fecha: hoy,
            tipo: tipo,
            monto: monto,
            producto: productoFinal, 
            timestamp: Date.now()
        };

        const movimientos = obtenerMovimientos();
        movimientos.push(nuevoMovimiento);
        guardarMovimientos(movimientos);

        document.getElementById('monto').value = '';
        document.getElementById('producto-select').value = ''; 
        document.getElementById('producto-manual').value = ''; 
    }

    function eliminarMovimiento(id) {
        const movimientos = obtenerMovimientos();
        const movimientosFiltrados = movimientos.filter(mov => mov.id !== id);
        guardarMovimientos(movimientosFiltrados);
    }

    function renderizarResumen() { 
        const movimientos = obtenerMovimientos();
        const hoy = new Date().toLocaleDateString('es-AR', { timeZone: 'America/Argentina/Buenos_Aires' });
        const movimientosDia = movimientos.filter(mov => mov.fecha === hoy);

        let totalVentas = 0;
        let totalCompras = 0;
        let totalGastos = 0;
        const productosContador = {}; 

        movimientosDia.forEach(mov => {
            const productoConsistente = normalizarProducto(mov.producto); 

            if (mov.tipo === 'venta') {
                totalVentas += mov.monto;
                productosContador[productoConsistente] = (productosContador[productoConsistente] || 0) + 1; 
            } else if (mov.tipo === 'compra') {
                totalCompras += mov.monto;
            } else if (mov.tipo === 'gasto') {
                totalGastos += mov.monto;
            }
        });

        const totalEgresos = totalCompras + totalGastos;
        const gananciaDia = totalVentas - totalEgresos;

        document.getElementById('total-ventas').textContent = `$${totalVentas.toFixed(2)}`;
        document.getElementById('total-compras').textContent = `$${totalCompras.toFixed(2)}`;
        document.getElementById('total-gastos').textContent = `$${totalGastos.toFixed(2)}`;
        
        const gananciaElement = document.getElementById('ganancia-valor');
        gananciaElement.textContent = `$${gananciaDia.toFixed(2)}`;
        gananciaElement.style.color = gananciaDia >= 0 ? 'var(--color-success)' : 'var(--color-danger)';

        // --- DETALLE DE MOVIMIENTOS ---
        const listaMov = document.getElementById('lista-movimientos');
        listaMov.innerHTML = '';
        movimientosDia.sort((a, b) => b.timestamp - a.timestamp).forEach(mov => {
            const li = document.createElement('li');
            const signo = mov.tipo === 'venta' ? '+' : '-';
            const claseMonto = mov.tipo === 'venta' ? 'monto-venta' : 'monto-gasto';
            
            const productoParaMostrar = normalizarProducto(mov.producto); 
            const tipoEtiqueta = (mov.tipo === 'compra') ? 'compra' : (mov.tipo === 'gasto' ? 'gasto' : 'venta');


            li.innerHTML = `
                <span>${productoParaMostrar} (${tipoEtiqueta})</span>
                <span class="${claseMonto}">${signo} $${mov.monto.toFixed(2)}</span>
                <button class="delete-btn" onclick="eliminarMovimiento(${mov.id})">üóëÔ∏è</button>
            `;
            listaMov.appendChild(li);
        });
        
        // --- TOP PRODUCTOS ---
        const topProductosList = document.getElementById('lista-top-productos');
        topProductosList.innerHTML = '';
        
        const sortedProductos = Object.entries(productosContador)
            .sort(([, a], [, b]) => b - a) 
            .slice(0, 5);

        if (sortedProductos.length === 0) {
             topProductosList.innerHTML = '<li>A√∫n no hay ventas registradas hoy.</li>';
        } else {
            sortedProductos.forEach(([producto, cantidad]) => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${producto}</strong>: ${cantidad} ventas`;
                topProductosList.appendChild(li);
            });
        }
       }

    function borrarDatosDia() { 
        if (document.body.classList.contains('app-blocked')) {
            alert("üõë Aplicaci√≥n Bloqueada. Suscripci√≥n Vencida. No se pueden realizar operaciones de borrado.");
            return;
        }
        
        const hoy = new Date().toLocaleDateString('es-AR', { timeZone: 'America/Argentina/Buenos_Aires' });
        
        if (!confirm(`¬°ATENCI√ìN! ¬øEst√°s seguro de que quieres BORRAR TODOS los movimientos de HOY (${hoy})? Esta acci√≥n es irreversible. Recuerda exportar si quieres conservar el registro.`)) {
            return;
        }
        
        const movimientos = obtenerMovimientos();
        const movimientosRestantes = movimientos.filter(mov => mov.fecha !== hoy);
        
        guardarMovimientos(movimientosRestantes);
        alert("Los movimientos del d√≠a han sido borrados con √©xito. Se mantiene el hist√≥rico de otros d√≠as.");
       }

    function exportarResumen() { 
        const movimientos = obtenerMovimientos();
        const hoy = new Date().toLocaleDateString('es-AR', { timeZone: 'America/Argentina/Buenos_Aires' });
        const movimientosDia = movimientos.filter(mov => mov.fecha === hoy);
        
        if (movimientosDia.length === 0) {
            alert("No hay datos del d√≠a para exportar.");
            return;
        }

        let csvContent = "data:text/csv;charset=utf-8,Tipo;Monto;Producto;Fecha\n";

        movimientosDia.forEach(mov => {
            const cleanProduct = normalizarProducto(mov.producto).replace(/,/g, ' '); 
            const montoLocal = mov.monto.toFixed(2).replace('.', ','); 
            const row = [mov.tipo, montoLocal, cleanProduct, mov.fecha].join(';');
            csvContent += row + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `resumen_caja_${hoy.replace(/\//g, '-')}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        alert("Resumen del d√≠a exportado con √©xito.");
    }


    // --- GESTI√ìN DE LICENCIA (Suscripci√≥n y Admin) ---

    function generarClientID() {
        let id = localStorage.getItem(CLIENT_ID_KEY);
        if (!id) {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let newId = '';
            for (let i = 0; i < 4; i++) newId += chars.charAt(Math.floor(Math.random() * chars.length));
            newId += '-';
            for (let i = 0; i < 4; i++) newId += chars.charAt(Math.floor(Math.random() * chars.length));
            id = newId;
            localStorage.setItem(CLIENT_ID_KEY, id);
        }
        document.getElementById('client-id-display').textContent = id;
        return id;
    }

    function generarCodigoActivacionDesdeID(clienteIdInput) {
         const cleanId = clienteIdInput.replace(/-/g, '');
         let codigoGenerado = '';
         for (let i = 0; i < cleanId.length; i++) {
             const charCode = cleanId.charCodeAt(i);
             const newCharCode = charCode + (i % 3) + 1;
             codigoGenerado += String.fromCharCode(newCharCode);
         }
         return (codigoGenerado.slice(0, 4) + 'X' + codigoGenerado.slice(4)).toUpperCase();
    }

    function pedirCodigoActivacion() {
        const codigo = prompt("Ingresa el C√≥digo de Activaci√≥n (o la frase secreta DEV si eres el administrador):");
        if (codigo) {
            const codigoLimpio = codigo.toUpperCase().trim();
            
            // 1. L√≥gica Exclusiva DEV: Comprueba la clave secreta
            if (codigoLimpio === ADMIN_UNLOCK_PHRASE.toUpperCase()) {
                 activarLicenciaAdmin();
                 return;
            }
            
            // 2. L√≥gica Normal de Cliente: Verifica c√≥digo de pago
            const expectedCode = generarCodigoActivacionDesdeID(generarClientID());
            
            if (codigoLimpio === expectedCode) {
                activarSuscripcion();
                alert("¬°Suscripci√≥n activada con √©xito! La aplicaci√≥n ya est√° lista para usar.");
            } else {
                alert("C√≥digo de activaci√≥n inv√°lido o incorrecto.");
            }
        }
    }
    
    function activarSuscripcion() {
        const expirationTime = Date.now() + SUB_DURATION_MS; // 30 d√≠as
        localStorage.setItem(SUBSCRIPTION_KEY, expirationTime);
        verificarSuscripcion();
    }

    function activarLicenciaAdmin() {
        localStorage.setItem(ADMIN_KEY, 'active');
        verificarSuscripcion();
        alert("üîë Licencia DEV activada. Ahora tienes acceso al Panel de Desarrollo.");
    }

    function verificarSuscripcion() {
        const statusElement = document.getElementById('subscription-status');
        const adminDevPanel = document.getElementById('admin-dev-panel');
        const payButton = document.getElementById('pay-button');
        const now = Date.now();
        
        // --- Verificaci√≥n DEV (ADMIN) ---
        const isAdminActive = localStorage.getItem(ADMIN_KEY) === 'active';
        if (isAdminActive) {
            adminDevPanel.style.display = 'block'; // Muestra solo para el desarrollador
            document.body.classList.remove('app-blocked');
            statusElement.className = 'alert-success';
            statusElement.textContent = "‚úÖ Licencia DEV Activa (ADMIN)";
            return;
        } else {
            adminDevPanel.style.display = 'none'; // Oculta para el resto
        }
        
        // --- Verificaci√≥n de Suscripci√≥n de Cliente Normal ---
        const expiryTimestamp = localStorage.getItem(SUBSCRIPTION_KEY);

        if (!expiryTimestamp) {
            // Primer uso / Per√≠odo de gracia.
            statusElement.className = 'alert-warning';
            statusElement.textContent = "‚ö†Ô∏è Per√≠odo de gracia. 3 d√≠as restantes.";
            document.body.classList.remove('app-blocked'); 
            payButton.classList.remove('disabled');
        } else if (now < parseInt(expiryTimestamp)) {
            // Suscripci√≥n Activa
            const daysLeft = Math.ceil((parseInt(expiryTimestamp) - now) / (24 * 60 * 60 * 1000));
            
            document.body.classList.remove('app-blocked');
            payButton.classList.remove('disabled');

            if (daysLeft <= 7) {
                statusElement.className = 'alert-warning';
                statusElement.textContent = `üü° Suscripci√≥n vence en ${daysLeft} d√≠as. ¬°Renueva!`;
            } else {
                statusElement.className = 'alert-success';
                statusElement.textContent = `üü¢ Suscripci√≥n Activa. Vence en ${daysLeft} d√≠as.`;
            }
        } else {
            // Suscripci√≥n Vencida (Bloqueo)
            document.body.classList.add('app-blocked');
            statusElement.className = 'alert-danger';
            statusElement.textContent = "üõë Aplicaci√≥n Bloqueada. Suscripci√≥n Vencida. ¬°Ingresa el c√≥digo de activaci√≥n!";
            payButton.classList.remove('disabled');
        }
    }
    
    // --- INICIALIZACI√ìN ---
    function init() {
        generarClientID();
        verificarSuscripcion(); 
        obtenerProductos(); 
        cargarSelectProductos();
        cargarEditorProductos(); 
        renderizarResumen();
    }

    window.onload = init;
</script>

</body>
</html>
