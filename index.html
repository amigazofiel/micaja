<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mi Caja ‚Äî Control r√°pido de caja</title>
  <style>
    :root{
      --bg:#f6f8fa;--card:#fff;--text:#0f1720;--muted:#6b7280;
      --green:#10b981;--red:#ef4444;--blue:#3b82f6;--accent:#6366f1;
    }
    [data-theme="dark"]{ --bg:#0b1220; --card:#071023; --text:#e6eef8; --muted:#9aa6bd }
    *{box-sizing:border-box}
    body{font-family:Inter,Segoe UI,Roboto,Arial,Helvetica,sans-serif; margin:0;background:var(--bg);color:var(--text);padding:18px}
    .container{max-width:920px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06);margin-bottom:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input[type="text"], input[type="number"]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,32,0.06)}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:white;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid rgba(15,23,32,0.06)}
    .summaries{display:flex;gap:12px}
    .summary{flex:1;padding:12px;border-radius:8px}
    .summary .value{font-size:20px;font-weight:700}
    .list{max-height:260px;overflow:auto;margin-top:8px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px;text-align:left;border-bottom:1px solid rgba(0,0,0,0.04);font-size:13px}
    .muted{color:var(--muted)}
    footer{margin-top:12px;text-align:center;color:var(--muted)}
    .theme-toggle{padding:8px;border-radius:8px;border:1px solid rgba(15,23,32,0.06);cursor:pointer}
    .overlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(2,6,23,0.55),rgba(2,6,23,0.65));display:flex;align-items:center;justify-content:center;z-index:9999}
    .overlay .panel{background:var(--card);padding:20px;border-radius:10px;max-width:420px;text-align:center;color:var(--text)}
    .small{font-size:13px}
    .trash{background:transparent;border:none;color:var(--red);cursor:pointer}
    @media(max-width:720px){.grid{grid-template-columns:1fr}.summaries{flex-direction:column}}
  </style>
</head>
<body>
  <div class="container" id="app">
    <header>
      <h1>Mi Caja ‚Äî Control r√°pido de caja</h1>
      <div class="controls">
        <button id="themeBtn" class="theme-toggle">Cambiar tema</button>
        <button id="exportBtn" class="btn ghost">Exportar CSV</button>
        <button id="payBtn" class="btn">Renovar suscripci√≥n</button>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <h3>Registrar venta</h3>
        <label class="muted">Descripci√≥n</label>
        <input id="saleDesc" type="text" placeholder="Ej: Yerba - Marca X" />
        <label class="muted">Importe</label>
        <input id="saleAmt" type="number" placeholder="0.00" />
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="addSale" class="btn">Agregar venta</button>
          <button id="quick5" class="btn ghost">+ 5</button>
          <button id="quick10" class="btn ghost">+ 10</button>
        </div>
      </div>

      <div class="card">
        <h3>Registrar gasto</h3>
        <label class="muted">Descripci√≥n</label>
        <input id="expDesc" type="text" placeholder="Ej: Compra de golosinas" />
        <label class="muted">Importe</label>
        <input id="expAmt" type="number" placeholder="0.00" />
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="addExp" class="btn" style="background:var(--red)">Agregar gasto</button>
          <button id="closeDay" class="btn ghost">Cerrar d√≠a</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="summaries">
        <div class="summary" style="background:linear-gradient(90deg,rgba(16,185,129,0.08),transparent)">
          <div class="muted">Ventas totales</div>
          <div id="totalSales" class="value">$ 0.00</div>
        </div>
        <div class="summary" style="background:linear-gradient(90deg,rgba(239,68,68,0.06),transparent)">
          <div class="muted">Gastos totales</div>
          <div id="totalExp" class="value">$ 0.00</div>
        </div>
        <div class="summary" style="background:linear-gradient(90deg,rgba(59,130,246,0.06),transparent)">
          <div class="muted">Ganancia neta</div>
          <div id="net" class="value">$ 0.00</div>
        </div>
      </div>

      <div class="list">
        <h4 style="margin:10px 0 6px 0">Historial (√∫ltimas entradas)</h4>
        <table>
          <thead><tr><th>Tipo</th><th>Descripci√≥n</th><th>Monto</th><th>Hora</th><th></th></tr></thead>
          <tbody id="history"></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="muted small">Suscripci√≥n</div>
        <div id="subInfo" style="font-weight:700">No activada</div>
        <div class="muted small">(El bot√≥n "Renovar suscripci√≥n" se puede reemplazar con tu link de pago)</div>
      </div>
      <div style="text-align:right">
        <button id="activateBtn" class="btn ghost">Activar con c√≥digo (demo)</button>
      </div>
    </div>

    <footer class="muted small">Mi Caja ‚Äî versi√≥n m√≠nima. Reemplaza el bot√≥n de pago por tu link o QR.</footer>
  </div>

  <div id="overlay" class="overlay" style="display:none">
    <div class="panel">
      <h3 id="overlayTitle">Suscripci√≥n expirada</h3>
      <p id="overlayMsg" class="small">Tu suscripci√≥n ha expirado. Tiempo restante para renovar:</p>
      <div id="countdown" style="font-size:22px;font-weight:700;margin:10px 0">24:00:00</div>
      <div style="display:flex;gap:8px;justify-content:center">
        <button id="overlayPay" class="btn">Renovar suscripci√≥n</button>
        <button id="overlayActivate" class="btn ghost">Ingresar c√≥digo</button>
      </div>
      <p class="muted small" style="margin-top:8px">Si no renuevas en las 24 horas, tu acceso permanecer√° bloqueado hasta que realices el pago.</p>
    </div>
  </div>

  <script>
    /* ---------- UTILIDADES ---------- */
    const $ = id => document.getElementById(id);
    const fmt = n => Number(n || 0).toLocaleString('es-AR',{style:'currency',currency:'ARS',minimumFractionDigits:2});

    /* ---------- ALMACENAMIENTO ---------- */
    const STORAGE_KEYS = {
      SALES: 'mjc_sales_v1',
      EXP: 'mjc_exp_v1',
      THEME: 'mjc_theme_v1',
      SUB: 'mjc_sub_v1'
    };

    function save(key, value){localStorage.setItem(key, JSON.stringify(value))}
    function load(key, fallback){const v=localStorage.getItem(key);return v?JSON.parse(v):fallback}

    let sales = load(STORAGE_KEYS.SALES, []);
    let exps = load(STORAGE_KEYS.EXP, []);
    let subscription = load(STORAGE_KEYS.SUB, null); // {start: ISO, end: ISO}

    /* ---------- RENDER ---------- */
    function render(){
      const totalSales = sales.reduce((s,i)=>s+Number(i.amt),0);
      const totalExp = exps.reduce((s,i)=>s+Number(i.amt),0);
      const net = totalSales - totalExp;
      $('totalSales').textContent = fmt(totalSales);
      $('totalExp').textContent = fmt(totalExp);
      $('net').textContent = fmt(net);

      const rows = [...sales.map(s=>({type:'Venta',desc:s.desc,amt:s.amt,ts:s.ts, id:s.id})), ...exps.map(e=>({type:'Gasto',desc:e.desc,amt:-Math.abs(e.amt),ts:e.ts, id:e.id}))]
        .sort((a,b)=> new Date(b.ts) - new Date(a.ts)).slice(0,200);
      const tbody = $('history'); tbody.innerHTML='';
      for(const r of rows){
        const tr = document.createElement('tr');
        const delBtn = `<button class=\"trash\" data-id=\"${r.id}\" data-type=\"${r.type}\" title=\"Borrar entrada\">üóëÔ∏è</button>`;
        tr.innerHTML = `<td>${r.type}</td><td>${escapeHtml(r.desc||'')}</td><td>${fmt(Math.abs(r.amt))}</td><td>${new Date(r.ts).toLocaleString()}</td><td>${delBtn}</td>`;
        tbody.appendChild(tr);
      }

      const subInfo = $('subInfo');
      if(subscription && subscription.end){
        const end = new Date(subscription.end);
        subInfo.textContent = `Activa hasta ${end.toLocaleString()}`;
      } else {
        subInfo.textContent = 'No activada';
      }

      checkSubscription();
    }

    function escapeHtml(str){return String(str).replace(/[&<>\"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[s])}

    /* ---------- ACCIONES ---------- */
    function generateId(){return Math.random().toString(36).slice(2,9)}

    $('addSale').addEventListener('click', ()=>{
      if(isBlocked()) return;
      const desc = $('saleDesc').value.trim();
      const amt = Number($('saleAmt').value || 0);
      if(!amt || amt<=0){alert('Ingrese un monto v√°lido.'); return}
      sales.push({id:generateId(), desc, amt, ts: new Date().toISOString()}); save(STORAGE_KEYS.SALES, sales); $('saleDesc').value=''; $('saleAmt').value=''; render();
    });
    $('addExp').addEventListener('click', ()=>{
      if(isBlocked()) return;
      const desc = $('expDesc').value.trim();
      const amt = Number($('expAmt').value || 0);
      if(!amt || amt<=0){alert('Ingrese un monto v√°lido.'); return}
      exps.push({id:generateId(), desc, amt, ts: new Date().toISOString()}); save(STORAGE_KEYS.EXP, exps); $('expDesc').value=''; $('expAmt').value=''; render();
    });

    $('quick5').addEventListener('click', ()=>{if(isBlocked()) return; $('saleAmt').value = Number($('saleAmt').value||0)+5});
    $('quick10').addEventListener('click', ()=>{if(isBlocked()) return; $('saleAmt').value = Number($('saleAmt').value||0)+10});

    document.addEventListener('click', (e)=>{
      if(e.target && e.target.matches('.trash')){
        const id = e.target.dataset.id; const type = e.target.dataset.type;
        if(!confirm('Confirmar borrado de la entrada. Esta acci√≥n no se puede deshacer.')) return;
        deleteEntry(id, type);
      }
    });

    function deleteEntry(id, type){
      if(type==='Venta'){
        const idx = sales.findIndex(s=>s.id===id); if(idx>-1){
          const removed = sales.splice(idx,1)[0];
          // A√±adir registro de anulaci√≥n en historial (audit)
          exps.push({id:generateId(), desc:`Anulaci√≥n venta: ${removed.desc}`, amt: removed.amt, ts: new Date().toISOString()});
          save(STORAGE_KEYS.SALES, sales); save(STORAGE_KEYS.EXP, exps); render();
        }
      } else {
        const idx = exps.findIndex(s=>s.id===id); if(idx>-1){
          const removed = exps.splice(idx,1)[0];
          // Registrar anulaci√≥n como ingreso
          sales.push({id:generateId(), desc:`Anulaci√≥n gasto: ${removed.desc}`, amt: removed.amt, ts: new Date().toISOString()});
          save(STORAGE_KEYS.SALES, sales); save(STORAGE_KEYS.EXP, exps); render();
        }
      }
    }

    $('closeDay').addEventListener('click', ()=>{
      if(isBlocked()) return;
      if(!confirm('¬øCerrar el d√≠a y borrar todas las ventas y gastos? Esta acci√≥n no se puede deshacer.')) return;
      sales=[]; exps=[]; save(STORAGE_KEYS.SALES, sales); save(STORAGE_KEYS.EXP, exps); render();
    });

    $('exportBtn').addEventListener('click', ()=>{
      const rows = [['Tipo','Descripci√≥n','Monto','Fecha']];
      for(const s of sales) rows.push(['Venta', s.desc, s.amt, s.ts]);
      for(const e of exps) rows.push(['Gasto', e.desc, -Math.abs(e.amt), e.ts]);
      const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""') }"`).join(',')).join('
');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='micaja_export.csv'; a.click(); URL.revokeObjectURL(url);
    });

    /* ---------- SUSCRIPCI√ìN (sin backend local) ---------- */
    function now(){return new Date()}
    function addMonths(date, n){
      const d = new Date(date.getTime());
      const day = d.getDate();
      d.setMonth(d.getMonth()+n);
      if(d.getDate() !== day){ d.setDate(0); }
      return d;
    }
    function activateSubscriptionFromNow(){
      const start = new Date();
      const end = addMonths(start,1); // mensual seg√∫n mes
      subscription = {start: start.toISOString(), end: end.toISOString()};
      save(STORAGE_KEYS.SUB, subscription);
      render();
      alert('Suscripci√≥n activada (demo). Vigente hasta ' + new Date(subscription.end).toLocaleString());
    }

    $('activateBtn').addEventListener('click', ()=>{
      const code = prompt('Ingrese el c√≥digo de activaci√≥n (demo: escribir "demo")');
      if(!code) return; if(code.trim().toLowerCase()==='demo'){ activateSubscriptionFromNow(); } else { alert('C√≥digo inv√°lido. En la versi√≥n real este flujo se completar√≠a tras verificar el pago.'); }
    });

    $('payBtn').addEventListener('click', ()=> openPayment());
    $('overlayPay').addEventListener('click', ()=> openPayment());
    $('overlayActivate').addEventListener('click', ()=> $('activateBtn').click());

    function openPayment(){
      // Aqu√≠ se abrir√≠a el checkout generado por tu backend.
      const paymentLink = '#';
      if(paymentLink==='#'){ alert('Reemplaza el link de pago en el c√≥digo con tu URL o muestra aqu√≠ un QR. En la versi√≥n con backend, se abrir√° el preference de Mercado Pago.'); return; }
      window.open(paymentLink,'_blank');
    }

    /* ---------- CHEQUEO Y BLOQUEO ---------- */
    let overlayInterval = null;
    function checkSubscription(){
      const ov = $('overlay');
      if(!subscription || !subscription.end){ ov.style.display='none'; return; }
      const end = new Date(subscription.end);
      const nowDt = now();
      if(nowDt <= end){ ov.style.display='none'; return; }
      const graceEnd = new Date(end.getTime() + 24*60*60*1000);
      if(nowDt <= graceEnd){ ov.style.display='flex'; $('overlayTitle').textContent = 'Suscripci√≥n vencida ‚Äî periodo de gracia'; startOverlayCountdown(graceEnd); return; }
      ov.style.display='flex'; $('overlayTitle').textContent = 'Suscripci√≥n vencida'; $('overlayMsg').textContent = 'Tu suscripci√≥n venci√≥ hace m√°s de 24 horas. Tu acceso est√° bloqueado hasta que renueves.'; $('countdown').textContent = ''; stopOverlayCountdown();
    }
    function startOverlayCountdown(targetDate){ stopOverlayCountdown(); function tick(){ const diff = targetDate - new Date(); if(diff<=0){ $('countdown').textContent = '00:00:00'; checkSubscription(); return; } const h = Math.floor(diff/3600000); const m = Math.floor((diff%3600000)/60000); const s = Math.floor((diff%60000)/1000); $('countdown').textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; } tick(); overlayInterval = setInterval(tick,1000); }
    function stopOverlayCountdown(){ if(overlayInterval) { clearInterval(overlayInterval); overlayInterval=null; } }
    function isBlocked(){ return $('overlay').style.display === 'flex'; }

    /* ---------- THEME ---------- */
    const storedTheme = load(STORAGE_KEYS.THEME, 'light');
    function applyTheme(t){ document.documentElement.setAttribute('data-theme', t==='dark'?'dark':'light'); save(STORAGE_KEYS.THEME, t); $('themeBtn').textContent = t==='dark' ? 'Tema claro' : 'Tema oscuro'; }
    $('themeBtn').addEventListener('click', ()=>{ const current = load(STORAGE_KEYS.THEME,'light'); applyTheme(current==='dark'?'light':'dark'); });
    applyTheme(storedTheme);

    /* ---------- INICIALIZACI√ìN ---------- */
    render();
    window.addEventListener('beforeunload', ()=>{ save(STORAGE_KEYS.SALES, sales); save(STORAGE_KEYS.EXP, exps); save(STORAGE_KEYS.SUB, subscription); });

    /* ---------- NOTAS Y SIGUIENTES PASOS (Backend & Cloud) ---------- */
    // En este mismo archivo incluimos placeholders para integrar el backend.
    // A continuaci√≥n (fuera del navegador) deber√≠as crear un peque√±o servidor Node.js que:
    // 1) Use Mercado Pago SDK para crear preferencias de pago (/create_preference).
    // 2) Exponga un webhook (/webhook_mp) que reciba las notificaciones de MP y, cuando confirme un pago,
    //    genere un c√≥digo de activaci√≥n √∫nico y lo guarde en Firestore (o similar), marcando al usuario como activo.
    // 3) Tenga rutas administrativas protegidas para listar suscriptores y c√≥digos.

    // PSEUDO-C√ìDIGO servidor (Node.js + Express) ‚Äî ver README para instalaci√≥n completa:
    /*
    const express = require('express');
    const mercadopago = require('mercadopago');
    const admin = require('firebase-admin');
    // inicializar mercadopago con ACCESS_TOKEN y firebase admin con credenciales

    app.post('/create_preference', async (req,res)=>{
      // req.body: {userId}
      const preference = {
        items:[{title:'Suscripci√≥n Mi Caja', quantity:1, unit_price:1000}],
        metadata:{userId: req.body.userId}
      }
      const mpPref = await mercadopago.preferences.create(preference);
      res.json({init_point: mpPref.body.init_point});
    });

    app.post('/webhook_mp', async (req,res)=>{
      // Mercado Pago env√≠a payment.id en query o en body. Buscar payment y validar que est√© aprobado.
      // Si aprobado -> generar c√≥digo √∫nico, guardar en Firestore junto al userId (metadata), y marcar suscripci√≥n con fecha de inicio y fin.
    });
    */

    // Si quer√©s, puedo: generar el repo backend con el c√≥digo Node.js listo (incluyendo ejemplo de webhook),
    // generar la estructura de Firestore para usuarios y activaciones, y crear el panel admin m√≠nimo.

  </script>
</body>
</html>
