<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Caja - Control Diario de Negocio</title>
    
    <style>
        /* --- ESTILOS (CSS) --- */
        :root {
            --color-primary: #007bff;
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-warning: #ffc107;
            --color-bg: #f8f9fa;
            --color-card: #ffffff;
            --color-text: #343a40;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-bg);
            color: var(--color-text);
        }

        header {
            background-color: var(--color-primary);
            color: white;
            padding: 15px;
            text-align: center;
        }

        header h1 {
            margin: 0;
            font-size: 1.8em;
        }

        #subscription-status {
            margin-top: 5px;
            font-size: 0.9em;
            padding: 5px;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.2);
            transition: background-color 0.5s;
        }

        main {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        section {
            background-color: var(--color-card);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h2, h3 {
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 5px;
            margin-top: 0;
        }

        /* Formulario de Ingreso */
        #input-section input,
        #input-section select,
        #input-section button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #ced4da;
            box-sizing: border-box;
        }
        
        #input-section button {
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #input-section button:first-of-type { /* Botón Agregar */
            background-color: var(--color-success);
            color: white;
        }

        #input-section button:first-of-type:hover {
            background-color: #218838;
        }
        
        /* Botón DEV oculto por defecto */
        #dev-license-btn {
            display: none; 
            background-color: #5d5d5d;
            color: white;
            border: none;
        }

        /* Resumen Diario */
        #resumen-diario p {
            font-size: 1.1em;
            margin: 5px 0;
        }

        #resumen-diario strong {
            float: right;
            font-weight: bold;
        }

        #ganancia-dia {
            font-size: 1.3em;
            border-top: 1px dashed #ced4da;
            padding-top: 10px;
            margin-top: 10px;
            display: block;
        }

        #resumen-diario button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            cursor: pointer;
            border: 1px solid #ced4da;
        }
        
        #resumen-diario button:first-of-type { /* Borrar */
             background-color: var(--color-danger);
             color: white;
             border: none;
        }
        
        .delete-info {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: -5px;
            margin-bottom: 10px;
            text-align: center;
        }

        /* Histórico */
        #lista-movimientos {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
        }

        #lista-movimientos li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .monto-venta { color: var(--color-success); font-weight: bold; }
        .monto-gasto, .monto-compra { color: var(--color-danger); font-weight: bold; }
        
        .delete-btn {
            background: none;
            border: none;
            color: var(--color-danger);
            cursor: pointer;
            font-size: 1.1em;
        }
        
        /* Suscripción */
        .pay-button {
            display: block;
            background-color: var(--color-warning);
            color: var(--color-text);
            text-align: center;
            padding: 12px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            margin-top: 15px;
            cursor: pointer;
        }

        .pay-button.disabled {
            background-color: #ccc;
            color: #666;
            cursor: not-allowed;
            pointer-events: none; /* Evita el click */
        }
        
        /* Bloqueo */
        .app-blocked #input-section,
        .app-blocked #resumen-diario button:not([onclick="exportarResumen()"]),
        .app-blocked #historico {
            opacity: 0.3;
            pointer-events: none;
        }
        
        .app-blocked #suscripcion {
             border: 3px solid var(--color-danger);
        }
        
        /* Estilos específicos del contador de alerta */
        .alert-warning { background-color: #ffeeba !important; color: #856404; }
        .alert-danger { background-color: #f5c6cb !important; color: #721c24; }
        .alert-success { background-color: #d4edda !important; color: #155724; }
        
        /* Oculta el panel de administrador por defecto */
        #admin-panel {
            display: none;
            border: 2px solid orange;
        }
        
    </style>
</head>
<body>
    <header>
        <h1>Mi Caja 💰</h1>
        <div id="subscription-status" class="alert-warning">Verificando...</div>
    </header>

    <main>
        <section id="input-section">
            <h2>Registrar Movimiento</h2>
            <select id="tipo-movimiento">
                <option value="venta">Venta (+)</option>
                <option value="gasto">Gasto (-)</option>
                <option value="compra">Compra (-)</option>
            </select>
            <input type="number" id="monto" placeholder="Monto (ej: 150.50)" step="0.01" required>
            <input type="text" id="producto" placeholder="Descripción o Nombre del Producto" required>
            <button onclick="agregarMovimiento()">Agregar</button>
            <button id="dev-license-btn" onclick="activarLicenciaAdmin()" title="Activa la licencia permanentemente (Sólo para ti)">🔑 Activar Licencia DEV</button>
        </section>

        <section id="resumen-diario">
            <h2>Resumen del Día</h2>
            <p>Ventas: <strong id="total-ventas">$0.00</strong></p>
            <p>Compras: <strong id="total-compras">$0.00</strong></p>
            <p>Gastos: <strong id="total-gastos">$0.00</strong></p>
            <p id="ganancia-dia">Ganancia del Día: <strong id="ganancia-valor">$0.00</strong></p>
            
            <button onclick="borrarDatosDia()">Borrar al Cerrar el Día</button>
            <p class="delete-info">⚠️ Si desea conservar los resultados, exporte los datos antes de borrar.</p>

            <button onclick="exportarResumen()">Exportar Resumen (CSV)</button>
        </section>

        <section id="historico">
            <h2>Detalle de Movimientos</h2>
            <ul id="lista-movimientos"></ul>
            <hr>
            <h3>Productos más Vendidos (Cantidad Hoy)</h3> 
            <ul id="lista-top-productos"></ul>
        </section>

        <section id="suscripcion">
            <h2>Suscripción ( $100 / mes )</h2>
            <p>Controla tu negocio, alivia tu mente.</p>
            <a href="[Tu Link de Pago Aquí]" target="_blank" class="pay-button" id="pay-button">Pagar Suscripción Ahora ($100/mes)</a>
        </section>
        
        <section id="admin-panel">
            <h2>🔧 Panel de Control (ADMIN)</h2>
            <p>Usa esto para gestionar las suscripciones de los clientes después de recibir su pago.</p>
            
            <button onclick="renovarSuscripcionCliente()" style="background-color: orange; color: black; border: none; padding: 10px; width: 100%; font-weight: bold; cursor: pointer;">
                Renovar Suscripción de Cliente
            </button>
        </section>
    </main>

    <footer>
        <p style="text-align: center; font-size: 0.8em; color: #6c757d; padding: 10px;">&copy; 2024 Mi Caja. Tus datos se guardan solo en tu navegador.</p>
    </footer>

    <script>
        // --- LÓGICA DE LA APLICACIÓN (JAVASCRIPT) ---
        
        // CLAVES IMPORTANTES
        const STORAGE_KEY = 'miCaja_movimientos';
        const SUBSCRIPTION_KEY = 'miCaja_subscripcion';
        const GRACE_PERIOD_MS = 24 * 60 * 60 * 1000;
        const SUB_DURATION_MS = 30 * 24 * 60 * 60 * 1000;
        const ADMIN_KEY = 'miCaja_admin_license';
        
        // CLAVE SECRETA PARA ACTIVAR EL MODO DEV (TÚ DECIDES ESTA FRASE)
        const ADMIN_UNLOCK_PHRASE = 'desarrollador-maestro'; 


        // --- FUNCIONES DE NORMALIZACIÓN Y CORRECCIÓN ORTOGRÁFICA ---

        /**
         * Normaliza el nombre del producto para evitar errores de tipeo y ortografía.
         * Teniendo en cuenta que muchos nombres se repiten (ej: Gaseosa, Pan, Arroz)
         * Se usa una lógica simple de "fuzzy matching" o mapeo manual.
         */
        function normalizarProducto(producto) {
            if (!producto) return '';
            
            const limpio = producto.toLowerCase().trim().replace(/[^a-z0-9\s]/g, '');

            // MAPEO MANUAL (AÑADE TANTOS PRODUCTOS COMUNES COMO NECESITES)
            if (limpio.includes('arroz')) return 'Arroz';
            if (limpio.includes('pan')) return 'Pan';
            if (limpio.includes('gaseosa') || limpio.includes('coca') || limpio.includes('pepsi')) return 'Gaseosa';
            if (limpio.includes('leche') || limpio.includes('lecche')) return 'Leche';
            if (limpio.includes('fideo') || limpio.includes('tallarin')) return 'Fideos';

            // Si no está mapeado, capitaliza la primera letra para que se vea ordenado.
            return producto.charAt(0).toUpperCase() + producto.slice(1).toLowerCase();
        }

        // --- FUNCIONES DE ACCESO Y SEGURIDAD ---

        /**
         * Muestra o esconde los elementos de desarrollo/administración.
         */
        function manejarVisibilidadAdmin(isAdmin) {
            const devBtn = document.getElementById('dev-license-btn');
            const adminPanel = document.getElementById('admin-panel');
            
            if (isAdmin) {
                devBtn.style.display = 'block';
                adminPanel.style.display = 'block';
            } else {
                devBtn.style.display = 'none';
                adminPanel.style.display = 'none';
            }
        }
        
        /**
         * Activa tu licencia DEV, pero solo si conoces la clave.
         */
        function activarLicenciaAdmin() {
            const promptValue = prompt("Para activar la Licencia DEV (Permanente), ingresa la clave secreta:");
            if (promptValue === ADMIN_UNLOCK_PHRASE) {
                localStorage.setItem(ADMIN_KEY, 'true');
                alert("¡Activación Exitosa! Licencia de Administrador activada permanentemente.");
                manejarVisibilidadAdmin(true);
                verificarSuscripcion();
            } else if (promptValue !== null) {
                alert("Clave incorrecta. Modo Administrador no activado.");
            }
        }

        /**
         * Verifica si se debe mostrar el botón DEV al iniciar la app
         */
        function verificarAccesoDev() {
            // Revisa si ya tienes la licencia activa
            const isAdmin = localStorage.getItem(ADMIN_KEY) === 'true';
            manejarVisibilidadAdmin(isAdmin);

            // También revisamos si el URL contiene la clave (para un acceso rápido)
            if (window.location.search.includes(ADMIN_UNLOCK_PHRASE)) {
                 manejarVisibilidadAdmin(true);
            }
        }
        
        // --- LÓGICA DE SUBSCRIPCIÓN Y BOTÓN DE PAGO ---
        
        /**
         * Activa/Desactiva el botón de pago y maneja el estado de la suscripción.
         */
        function verificarSuscripcion() {
            const isAdmin = localStorage.getItem(ADMIN_KEY) === 'true';
            const subData = JSON.parse(localStorage.getItem(SUBSCRIPTION_KEY));
            const now = new Date().getTime();
            const statusElement = document.getElementById('subscription-status');
            const payButton = document.getElementById('pay-button');

            // 1. MODO DEV ACTIVO
            if (isAdmin) {
                document.body.classList.remove('app-blocked');
                statusElement.innerHTML = `⭐ **LICENCIA DEV ACTIVA**: Uso ilimitado.`;
                statusElement.classList.remove('alert-warning', 'alert-danger');
                statusElement.classList.add('alert-success');
                payButton.classList.add('disabled'); // Deshabilita el pago
                return; 
            }
            
            // 2. LÓGICA NORMAL DE CLIENTE
            statusElement.className = '';
            
            // Si la suscripción está activa (no expirada)
            if (subData && now < subData.expiryDate) {
                document.body.classList.remove('app-blocked');
                const daysLeft = Math.ceil((subData.expiryDate - now) / (24 * 60 * 60 * 1000));
                statusElement.innerHTML = `✅ Suscripción Activa. ¡Disfruta de tu control! Quedan ${daysLeft} días.`;
                statusElement.classList.add('alert-success');
                payButton.classList.add('disabled'); // Deshabilita el pago: NO HAY QUE PAGAR
                return;
            }
            
            // 3. SIN DATOS / EXPIRADO (LÓGICA DE BLOQUEO)
            payButton.classList.remove('disabled'); // Habilita el pago
            const graceExpiry = subData ? subData.expiryDate + GRACE_PERIOD_MS : 0;
            
            // 3a. PERÍODO DE GRACIA (24 horas)
            if (now < graceExpiry) {
                document.body.classList.remove('app-blocked');
                const timeLeft = graceExpiry - now;
                const hoursLeft = Math.ceil(timeLeft / (60 * 60 * 1000));
                
                statusElement.innerHTML = `⚠️ **AVISO AMABLE**: Tu suscripción expira pronto. Tienes ${hoursLeft} horas para renovar y mantener tu control.`;
                statusElement.classList.add('alert-warning');
            } 
            // 3b. BLOQUEO TOTAL
            else {
                document.body.classList.add('app-blocked');
                statusElement.innerHTML = `⛔ **CONTROL SUSPENDIDO**: Gracias por usar Mi Caja. Para reanudar el acceso a todas las funciones y tu historial, por favor, renueva tu suscripción.`;
                statusElement.classList.add('alert-danger');
            }
        }

        /**
         * Función para renovar la suscripción de un cliente después de recibir el pago.
         */
        function renovarSuscripcionCliente() {
            const expiryDate = new Date().getTime() + SUB_DURATION_MS; // 30 días
            const subData = { expiryDate: expiryDate };
            localStorage.setItem(SUBSCRIPTION_KEY, JSON.stringify(subData));
            alert("¡Suscripción de cliente renovada con éxito por 30 días!");
            verificarSuscripcion();
        }

        // --- FUNCIONES DE CAJA Y ALMACENAMIENTO ---

        function obtenerMovimientos() {
            const movimientos = localStorage.getItem(STORAGE_KEY);
            return movimientos ? JSON.parse(movimientos) : [];
        }

        function guardarMovimientos(movimientos) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(movimientos));
            renderizarResumen();
        }

        /**
         * Agrega un nuevo movimiento (venta, gasto, compra) con producto normalizado.
         */
        function agregarMovimiento() {
            if (document.body.classList.contains('app-blocked')) {
                alert("La aplicación está suspendida. Por favor, renueva tu suscripción para continuar.");
                return;
            }
            
            const tipo = document.getElementById('tipo-movimiento').value;
            const monto = parseFloat(document.getElementById('monto').value);
            const productoInput = document.getElementById('producto').value;
            
            // *** APLICAR AUTOCORRECCIÓN/NORMALIZACIÓN AQUÍ ***
            const productoNormalizado = normalizarProducto(productoInput);

            if (monto > 0 && productoNormalizado) {
                const hoy = new Date().toLocaleDateString('es-AR', { timeZone: 'America/Argentina/Buenos_Aires' });
                const nuevoMovimiento = {
                    id: Date.now(), 
                    fecha: hoy,
                    tipo: tipo,
                    monto: monto,
                    producto: productoNormalizado, // Usamos el nombre corregido
                    timestamp: Date.now()
                };

                const movimientos = obtenerMovimientos();
                movimientos.push(nuevoMovimiento);
                guardarMovimientos(movimientos);

                document.getElementById('monto').value = '';
                document.getElementById('producto').value = '';
            } else {
                alert("Por favor, ingresa un monto válido y una descripción del producto.");
            }
        }

        function eliminarMovimiento(id) {
            if (!confirm("¿Seguro que deseas eliminar este movimiento? Esta acción no se puede deshacer.")) return;
            
            const movimientos = obtenerMovimientos();
            const nuevosMovimientos = movimientos.filter(mov => mov.id !== id);
            guardarMovimientos(nuevosMovimientos);
        }

        /**
         * Calcula los totales y el Top Productos (por CANTIDAD de registros).
         */
        function renderizarResumen() {
            const movimientos = obtenerMovimientos();
            const hoy = new Date().toLocaleDateString('es-AR', { timeZone: 'America/Argentina/Buenos_Aires' });
            const movimientosDia = movimientos.filter(mov => mov.fecha === hoy);

            let totalVentas = 0;
            let totalCompras = 0;
            let totalGastos = 0;
            const productosContador = {}; // Para el Top Ventas por CANTIDAD

            movimientosDia.forEach(mov => {
                if (mov.tipo === 'venta') {
                    totalVentas += mov.monto;
                    // Contar CADA VENTA de producto
                    productosContador[mov.producto] = (productosContador[mov.producto] || 0) + 1; 
                } else if (mov.tipo === 'compra') {
                    totalCompras += mov.monto;
                } else if (mov.tipo === 'gasto') {
                    totalGastos += mov.monto;
                }
            });

            const totalEgresos = totalCompras + totalGastos;
            const gananciaDia = totalVentas - totalEgresos;

            // Actualizar Resumen
            document.getElementById('total-ventas').textContent = `$${totalVentas.toFixed(2)}`;
            document.getElementById('total-compras').textContent = `$${totalCompras.toFixed(2)}`;
            document.getElementById('total-gastos').textContent = `$${totalGastos.toFixed(2)}`;
            
            const gananciaElement = document.getElementById('ganancia-valor');
            gananciaElement.textContent = `$${gananciaDia.toFixed(2)}`;
            gananciaElement.style.color = gananciaDia >= 0 ? 'var(--color-success)' : 'var(--color-danger)';

            // Actualizar Detalle de Movimientos (Sin cambios)
            const listaMov = document.getElementById('lista-movimientos');
            listaMov.innerHTML = '';
            movimientosDia.sort((a, b) => b.timestamp - a.timestamp).forEach(mov => {
                const li = document.createElement('li');
                const signo = mov.tipo === 'venta' ? '+' : '-';
                const claseMonto = mov.tipo === 'venta' ? 'monto-venta' : 'monto-gasto';
                
                li.innerHTML = `
                    <span>${mov.producto} (${mov.tipo})</span>
                    <span class="${claseMonto}">${signo} $${mov.monto.toFixed(2)}</span>
                    <button class="delete-btn" onclick="eliminarMovimiento(${mov.id})">🗑️</button>
                `;
                listaMov.appendChild(li);
            });
            
            // Actualizar Top Productos Vendidos (Por CANTIDAD)
            const topProductosList = document.getElementById('lista-top-productos');
            topProductosList.innerHTML = '';
            
            const sortedProductos = Object.entries(productosContador)
                .sort(([, a], [, b]) => b - a) // Ordenar por CANTIDAD (el valor 'a' o 'b')
                .slice(0, 5);

            if (sortedProductos.length === 0) {
                 topProductosList.innerHTML = '<li>Aún no hay ventas registradas hoy.</li>';
            } else {
                sortedProductos.forEach(([producto, cantidad]) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${producto}</strong>: ${cantidad} ventas`;
                    topProductosList.appendChild(li);
                });
            }
        }

        // --- FUNCIONES RESTANTES (borrar y exportar) ---

        function borrarDatosDia() {
            const hoy = new Date().toLocaleDateString('es-AR', { timeZone: 'America/Argentina/Buenos_Aires' });
            
            if (!confirm(`¡ATENCIÓN! ¿Estás seguro de que quieres BORRAR TODOS los movimientos de HOY (${hoy})? Esta acción es irreversible. Recuerda exportar si quieres conservar el registro.`)) {
                return;
            }
            
            const movimientos = obtenerMovimientos();
            const movimientosRestantes = movimientos.filter(mov => mov.fecha !== hoy);
            
            guardarMovimientos(movimientosRestantes);
            alert("Los movimientos del día han sido borrados con éxito. Se mantiene el histórico de otros días.");
        }

        function exportarResumen() {
            const movimientos = obtenerMovimientos();
            const hoy = new Date().toLocaleDateString('es-AR', { timeZone: 'America/Argentina/Buenos_Aires' });
            const movimientosDia = movimientos.filter(mov => mov.fecha === hoy);
            
            if (movimientosDia.length === 0) {
                alert("No hay datos del día para exportar.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,Tipo,Monto,Producto,Fecha\n";

            movimientosDia.forEach(mov => {
                const cleanProduct = mov.producto.replace(/,/g, ' '); 
                const row = [mov.tipo, mov.monto.toFixed(2), cleanProduct, mov.fecha].join(',');
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `resumen_caja_${hoy.replace(/\//g, '-')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert("Resumen del día exportado con éxito.");
        }

        // Iniciar la aplicación al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            verificarAccesoDev(); // Primero revisa si eres el administrador
            verificarSuscripcion();
            renderizarResumen(); 
            
            // Configurar la verificación de suscripción cada 1 minuto
            setInterval(verificarSuscripcion, 60 * 1000); 
        });

    </script>
</body>
</html>
